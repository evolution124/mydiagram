<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0" version="25.0.3">
  <diagram name="Page-1" id="9GhINJhexpfvpIPdTT9F">
    <mxGraphModel dx="2888" dy="7223" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-84" value="&lt;span style=&quot;text-align: left;&quot;&gt;Start Address: 55AD 21F6 3900&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5880" y="-1380" width="100" height="50" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-6" value="gc_hal_kernel_hardware_waitlink_fe.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_Link(hardware, Logical, FetchAddress, FetchSize, Bytes, Low, High)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; address = FetchAddress&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //CommandBuffer 算是offset的Device地址&lt;br&gt;&amp;nbsp; &amp;nbsp; High = FetchAddress&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bytes = align(FetchAddress + FetchSize, 64) - FetchAddress //CommandBuffer 有效的大小&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Hardware-&amp;gt;graphicsLargeVA) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 1, 0)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// OPCODE先清零(配置好 cmd再设置 OPCODE&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 2，address)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 低32位&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 3 , FetchAddress &amp;gt;&amp;gt; 32);&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 高32位&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;link = ... //设置link为 LINK64 并且PREFETCH大小为bytes&amp;gt;&amp;gt;3 &lt;font color=&quot;#ff3333&quot;&gt;// 配置link的 opcode&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckOS_WriteMemory(os, logical, link)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 设置CMD的 OPCODE, Prefetch&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;Low = link&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="10350" y="-1800" width="720" height="290" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-8" value="gc_hal_kernel_hardware_waitlink_fe.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_WaitLink(hardware, Logical, Address, Offset, Bytes, WaitOffset, WaitSize)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; hw-&amp;gt;lastWaitLink = Address //保存 WAIT/LINK的地址&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; opLogical = Logical;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//设置WAIT命令&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical++ = ... // WAIT64 与 hw-&amp;gt;waitCount;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; opLogical++&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//设置LINK命令, 当前LINK到 WAIT命令, 形成LOOP&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical++ = ...// LINK64 与 PREFETCH&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical = Address;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WaitOffset = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WaitSize = waitSize;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Bytes = bytes;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="10350" y="-1400" width="720" height="260" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-10" value="gc_hal_kernel_hardware.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckHARDWARE_Fence(hardware, Engine, Logical, FenceAddress, FenceData, Bytes)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; if (Engine == gcvENGINE_RENDER)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; _FenceRender(hw, Logical, FenceAddress, FenceData, Bytes)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; dataLow = FenceData&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dataHigh = FenceData &amp;gt;&amp;gt; 32&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (logical) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE....)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E75 gcregFenceAddressHiRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, FenceAddress &amp;gt;&amp;gt; 32); //设置Fence State 地址高32bit&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...) //设置 E1A gcregFenceAddressRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, fenceAddress)&amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 fence低32位&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E26 gcregFenceDataHighRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, dataHigh)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E1B gcregFenceDataRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, dataLow)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Bytes = gcdRENDER_FENCE_LENGTH+8&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="10350" y="-1039" width="720" height="360" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-12" value="&lt;div&gt;gc_hal_kernel_kernel.cpp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckKERNEL_Notify(kernel, Notification)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; switch(Notification) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; case gcvNOTIFY_INTERRUPT:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckHARDWARE_Notify(kernel-&amp;gt;hardware)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; gckEVENT_Notify(Hardware-&amp;gt;kernel-&amp;gt;eventObj, 0, &amp;amp;fault);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; for (;;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckOS_AtomGet(Event-&amp;gt;os, Event-&amp;gt;pending, &amp;amp;pending);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if( pending &amp;amp; (1&amp;lt;&amp;lt;29) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//event29 是 invalidation pipe的特殊EVENT&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if( pending &amp;amp; 0x80000000) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//AXI bus error&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if (pending &amp;amp; 0x40000000) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// MMU exception&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckFENCE_Signal(os, Event-&amp;gt;kernel-&amp;gt;command-&amp;gt;fence)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="11280" y="-1579" width="450" height="400" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="11495" y="-1660" as="sourcePoint" />
            <mxPoint x="11495" y="-1600" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-13" value="&lt;div&gt;gc_hal_kernel_emulator.cpp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;InterruptThread(void *)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;while(wrapper-&amp;gt;interruptSuspended)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;gckHARDWARE_Interrupt(kernel-&amp;gt;hardware)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;gckKERNEL_Notify(kernel, gcvNOTIFY_INTERRUPT)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="11280" y="-1799" width="450" height="160" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-1" value="&lt;span style=&quot;text-align: left;&quot;&gt;drv_api.cpp&lt;/span&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="-1435" width="630" height="606" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-2" value="&lt;div&gt;&lt;b&gt;drvLaunchKernelEx_common(config, f, kernelParams, extra, ptsz):&lt;br&gt;&lt;/b&gt;&amp;nbsp; &amp;nbsp; kernelParams: 就是user传入的args,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; extra: ???&amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; ptsz: 是否是perThread Stream&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-1" vertex="1">
          <mxGeometry y="26" width="630" height="74" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-3" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//获取CUcontext&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;div&gt;ctx = getCurrentContext()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;//获取gridDimX/Y/Z, blockDimX/Y/Z, sharedMemBytes等配置信息&lt;br&gt;&lt;/span&gt;gridDimX = config-&amp;gt;gridDimX&lt;br&gt;...&lt;br&gt;sharedMemBytes = config-&amp;gt;sharedMemBytes&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//获取CUStream&lt;/span&gt;&lt;/div&gt;&lt;div&gt;hStream = getCurrentStream(ctx, stream, perThread)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//根据 f-&amp;gt;kernelInfo-&amp;gt;argCount 创建kernelArgData_t&lt;/span&gt;&lt;/div&gt;&lt;div&gt;kernelArgData_t* argData = malloc(sizeof(kernelArgData_t)*argCount)&lt;/div&gt;&lt;div&gt;for (;;) {&lt;br&gt;&amp;nbsp; &amp;nbsp; kernelArgData_t data = argData + i;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; kernelArg_t arg = &lt;font color=&quot;#ff3333&quot;&gt;f-&amp;gt;kernelInfo&lt;/font&gt;-&amp;gt;args + i;&lt;br&gt;&amp;nbsp; &amp;nbsp; data-&amp;gt;arg = arg&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ... //&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//准备 halQueue_t 与 halCommand_t&lt;/span&gt;&lt;br&gt;halQueue = getCurrentStream(ctx, hStream, false)-&amp;gt;halQueue &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//此时 hStream是有效指针, 基本是直接返回&lt;/span&gt;&lt;br&gt;command = {&lt;font color=&quot;#ff3333&quot;&gt;COMMAND_KERNEL&lt;/font&gt;} &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//设置command 为KERNEL(type 有COPY, WAIT, FENCE 等)&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#ff3333&quot;&gt;executeKrnelInfo_t&lt;/font&gt; *info = command.kernelInfo&lt;br&gt;info-&amp;gt;local[0] = blockDimX...; info-&amp;gt;gridDim[0] = gridDimX ...; info-&amp;gt;global[0]= gridDimX*info-&amp;gt;local[0] ...&lt;br&gt;info-&amp;gt;args = argData;&lt;/div&gt;&lt;div&gt;info-&amp;gt;kInfo= f-&amp;gt;kernelInfo;&lt;br&gt;info-&amp;gt;inst = f-&amp;gt;kernel&lt;/div&gt;&lt;div&gt;prepareExecInfo(info)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//调用&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#ff3333&quot;&gt;&lt;b&gt;launchCommand(halQueue, &amp;amp;command)&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-1" vertex="1">
          <mxGeometry y="100" width="630" height="480" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-32" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-1" vertex="1">
          <mxGeometry y="580" width="630" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-5" value="Color Chart" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="-1788" width="395" height="138" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-7" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="26" width="395" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-6" value="Context" style="text;strokeColor=#6c8ebf;fillColor=#dae8fc;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="34" width="395" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-8" value="Command" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="60" width="395" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-16" value="Comment" style="text;strokeColor=#82b366;fillColor=#FFFFCC;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="86" width="395" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-17" value="???" style="text;strokeColor=#82b366;fillColor=#FFE599;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="112" width="395" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-9" value="&lt;span style=&quot;text-align: left;&quot;&gt;stream.cpp&lt;/span&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-1135" width="490" height="220" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-10" value="&lt;div&gt;&lt;b&gt;getCurrentStream(CUcontext ctx, CUStream stream, bool perThread):&lt;br&gt;&lt;/b&gt;&amp;nbsp; &amp;nbsp; stream 用户传入的stream&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-9" vertex="1">
          <mxGeometry y="26" width="490" height="44" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-11" value="&lt;div&gt;istream = (size_t)stream;&lt;/div&gt;switch(istream)&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;case 0: return getDefaultStream(ctx, perThread)&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; 如果perThread --&amp;gt; getPerThreadStream(ctx)&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;否则 --&amp;gt;getLegacyStream(ctx) --&amp;gt; ctx-&amp;gt;legacy &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;(如何创建???)&lt;/span&gt;&lt;br&gt;case 1: return getLegacyStream(ctx)&lt;br&gt;case 2: return getPerThreadStream(ct)&lt;br&gt;default:&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;... &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//和delayDestroy 相关 ???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-9" vertex="1">
          <mxGeometry y="70" width="490" height="150" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-19" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;drv_api.cpp&lt;/span&gt;&lt;/div&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-1425" width="490" height="140" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-20" value="&lt;div&gt;&lt;b&gt;getCurrentContext():&lt;/b&gt;&amp;nbsp;获取当前的context&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-19" vertex="1">
          <mxGeometry y="26" width="490" height="24" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-21" value="&lt;div&gt;tssData_PTR tss = getTssData(); &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取线程本地数据&lt;/span&gt;&lt;br&gt;&lt;br&gt;ctx = utilStackTop(tss-&amp;gt;ctxStack); &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取最近创建的CUcontext&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return gpgpuPLS.drvDevices[tss-&amp;gt;runtimeDeviceId]-&amp;gt;primaryCtx &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//如何创建???&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-19" vertex="1">
          <mxGeometry y="50" width="490" height="90" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-25" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-880" y="-755" width="390" height="176" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-26" value="&lt;b&gt;launchCommand(halQueue_PTR queue, halCommand_t * cmd)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="26" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-27" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="52" width="390" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-28" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//根据type调用相应的函数&lt;br&gt;&lt;/span&gt;switch(cmd-&amp;gt;type)&lt;br&gt;case &lt;font color=&quot;#ff3333&quot;&gt;COMMAND_KERNEL&lt;/font&gt;: &lt;b&gt;executeKernel(queue, cmd)&lt;/b&gt;&lt;br&gt;...&lt;br&gt;case&amp;nbsp;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="60" width="390" height="90" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-34" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="150" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-33" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.501;exitY=1.038;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-32" target="QSAenKkpdjQW8zQk9t1L-25" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-980" y="-785" as="sourcePoint" />
            <mxPoint x="-900" y="-785" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-35" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-962" y="-475" width="550" height="320" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-36" value="&lt;b&gt;executeKernel(halQueue_PTR queue, halCommand* halCmd)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-35" vertex="1">
          <mxGeometry y="26" width="550" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-37" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-35" vertex="1">
          <mxGeometry y="52" width="550" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-38" value="executeKernelInfo_t * execInfo = &amp;amp;halCmd-&amp;gt;kernelInfo&lt;br&gt;&lt;br&gt;execInfo-&amp;gt;halQueue = queue&lt;br&gt;cmdBuffer_PTR &lt;font color=&quot;#ff3333&quot;&gt;cmdBuffer &lt;/font&gt;= &lt;b&gt;createCommandBuffer&lt;/b&gt;(processor, 1024, 1024)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;clfBeginVIRUniform(&lt;font color=&quot;#ff3333&quot;&gt;cmdBuffer&lt;/font&gt;, execInfo-&amp;gt;inst, null)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; //添加硬件配置cmd, 并且写入 semaphoreStall 与 Stall 命令&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;__clCmdLoadSingalHWState(states, AQSemaphoreRegAddrs, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;__clCmdLoadingFECommand(states, STALL, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;allocInternalMemory(execInfo)&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;clfEndVIRUniform(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;clfInvokeVIRKernel&lt;/b&gt;(cmdBuffer, execInfo-&amp;gt;inst, execInfo-&amp;gt;workDim, ...., &amp;amp;invokeInfo)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//把cmdBuffer挂载到queue的commandQueue上&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;addCmdToQueue&lt;/b&gt;(queue, cmdBuffer)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-35" vertex="1">
          <mxGeometry y="60" width="550" height="260" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-39" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.51;entryY=0.005;entryDx=0;entryDy=0;exitX=0.508;exitY=1.035;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-34" target="QSAenKkpdjQW8zQk9t1L-35" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-674" y="-818" as="sourcePoint" />
            <mxPoint x="-675" y="-745" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-41" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-715" width="460" height="300" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-42" value="&lt;b&gt;createCommandBuffer(processor, size)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-41" vertex="1">
          <mxGeometry y="26" width="460" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-43" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-41" vertex="1">
          <mxGeometry y="52" width="460" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-44" value="cmd = malloc(sizeof(cmdBuffer_t))&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//通过cmd-Buffer - cmdBase 可以计算cmd的个数&lt;br&gt;&lt;/span&gt;cmd-&amp;gt;cmdBase = malloc(size)&lt;br&gt;cmd-&amp;gt;cmdBuffer = cmd-&amp;gt;cmdBase&lt;br&gt;cmd-&amp;gt;processor = processor&lt;br&gt;cmd-&amp;gt;helper.index = gCmdIdx++;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//向cmdBuffer中添加init cmds&lt;/span&gt;&lt;/div&gt;&lt;div&gt;clfInitCommandQueue(cmd)&lt;br&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//通过&amp;nbsp;__clCmdLoadSingleHWState 往cmdBuffer添加LoadState 配置&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;28A AQSystemRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E13 AQModeRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;5580 gcregShaderMiscConfigRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E44 gcregClusterControlRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E80 gcregMultiChipControlRegAddrs&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-41" vertex="1">
          <mxGeometry y="60" width="460" height="240" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-45" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=-0.005;entryY=0.053;entryDx=0;entryDy=0;exitX=1.006;exitY=0.166;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-41" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-672" y="-548" as="sourcePoint" />
            <mxPoint x="-669" y="-474" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-46" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.003;entryY=0.111;entryDx=0;entryDy=0;exitX=1.002;exitY=0.298;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-3" target="QSAenKkpdjQW8zQk9t1L-19" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-360" y="-1049" as="sourcePoint" />
            <mxPoint x="-243" y="-1265" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-47" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.001;entryY=0.083;entryDx=0;entryDy=0;exitX=0.997;exitY=0.594;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-3" target="QSAenKkpdjQW8zQk9t1L-9" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-359" y="-1182" as="sourcePoint" />
            <mxPoint x="-199" y="-1359" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-48" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-385" width="530" height="560" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-49" value="&lt;b&gt;clfInvokeVIRKernel(cmdBuffer_PTR cmdBuffer, KernelInst_PTR kernelInst,...)&lt;br&gt;通过将要运行的kernel, 配置cmd buffer&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-48" vertex="1">
          <mxGeometry y="26" width="530" height="44" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-50" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-48" vertex="1">
          <mxGeometry y="70" width="530" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-51" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;compilerCmd = *states; //states 就是cmdBuffer-&amp;gt;cmdBuffer&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;compilerCmdCount = hwStates-&amp;gt;stateBufferSize/sizeof(uint32_t)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //22&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;memcpy(*states, hwStates-&amp;gt;pStateBuffer, hwStates-&amp;gt;stateBufferSize)&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;*states += compilerCmdCount;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//配置指令地址 0x040A&lt;/span&gt;&lt;div&gt;physical = getDeviceAddr(kernelInst-&amp;gt;instMem, kernelInst-&amp;gt;processor)&lt;br&gt;__clCmdLoadSingleHWState(states, gcregPSInstructionRegAddrs, physical)&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//NN相关&lt;/span&gt;&lt;/div&gt;&lt;div&gt;clfTCBasicConfig(cmdBuffer, kernelInst)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//Load State 配置&lt;/div&gt;&lt;div&gt;AQPixelShaderInputControlRegAddrs&amp;nbsp;&lt;br&gt;AQPixelShaderTemporaryRegisterControlRegAddrs&lt;/div&gt;&lt;div&gt;AQPixelShaderControlRegAddrs&lt;br&gt;gcregVSThrottleRegAddrs ...&lt;br&gt;&lt;/div&gt;&lt;div&gt;gcregVSInstructionPrefetchRegAddrs ...&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;_clCmdLoadSingleHWState(states, gcregTWTriggerRegAddrs, 0xBADABEEB)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;AQFlushRegAddrs&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//Semaphare STALL&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, AQSemaphoreRegAddrs, semaphoreStall);&lt;br&gt;__clCmdLoadSignleFECommand(states, STALL, semaphoreStall);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//通过semaphore同步&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;MultiGPUSync(cmdBuffer)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//Invalid ICache&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregSHIcacheInvalidateRegAddrs, ...)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-48" vertex="1">
          <mxGeometry y="78" width="530" height="482" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-52" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-51" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-399" y="-357" as="sourcePoint" />
            <mxPoint x="-202" y="-589" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-57" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="276" width="530" height="190" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-58" value="&lt;b&gt;addCmdToQueue(halQueue_PTR queue, cmdBuffer_PTR cmdBuffer)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-57" vertex="1">
          <mxGeometry y="26" width="530" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-59" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-57" vertex="1">
          <mxGeometry y="52" width="530" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-60" value="&lt;b&gt;updateHalqueueFence&lt;/b&gt;(queue, queue-&amp;gt;processor, cmdBuffer)&lt;br&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; queue-&amp;gt;halFence-&amp;gt;expectedVal = cmdBuffer-&amp;gt;helper.index; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;// gCmdIdx++ 初始化&lt;/span&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; addr = getFenceGPULogical(queue-&amp;gt;halFence, processor)&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; fence-&amp;gt;node-&amp;gt;gpuLogical + fence-&amp;gt;offsetInBytes&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;clfSendFenceWithEngine&lt;/b&gt;(cmdBuffer, fence-&amp;gt;expectedVal, addr, 0)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//把cmdBuffer 挂载到queue-&amp;gt;commandQueue上面&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;os_queue_append&lt;/b&gt;(queue-&amp;gt;commandQueue, cmdBuffer)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-57" vertex="1">
          <mxGeometry y="60" width="530" height="130" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-61" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.997;exitY=0.824;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-57" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-505" y="95" as="sourcePoint" />
            <mxPoint x="-343" y="318" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-62" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="400" y="295" width="690" height="450" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-63" value="&lt;b&gt;clfSendFenceWithEngine(cmdBuffer_PTR cmdBuffer, uint64_t data, devAddress_t dstAddress, int32_t engine)&lt;br&gt;&lt;/b&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;// data 就是expectedVal,&amp;nbsp; &lt;br&gt;// dstAddress是GPU看到的halFence_PTR地址&lt;br&gt;// engine ??&lt;/span&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-62" vertex="1">
          <mxGeometry y="26" width="690" height="74" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-64" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-62" vertex="1">
          <mxGeometry y="100" width="690" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-65" value="dataL = data &amp;amp; 0xFFFFFFFF&lt;div&gt;dataH = (data&amp;gt;&amp;gt;32) &amp;amp;0xFFFFFFFF&lt;br&gt;&lt;br&gt;dstAddressHigh = devADDRESS_HIGH(dstAddress)&lt;br&gt;dstAddressLow&amp;nbsp; = devADDRESS_LOW(dstAddress)&lt;br&gt;&lt;br&gt;if(engine == gcvENGINE_BLT) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (hasBlt) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //Semaphore 配置???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleHWState(states, gcregBltGeneralControlRegAddrs, LOCK)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;__clCmdLoadSingleHWState(states, AQSemaphoreRegAddrs, semaphoreStall)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleFECommand(states, STALL, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleHWState(states, gcregBltGeneralControlRegAddrs, UNLOCK)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else { ...&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//添加Fence cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregFenceAddressRegAddrs, dstAddressLow)&lt;br&gt;__clCmdLoadSingleHWState(states, gcregFenceDataHighRegAddrs, dataH)&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregFenceDataRegAddrs, dataL)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-62" vertex="1">
          <mxGeometry y="108" width="690" height="342" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-66" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=-0.003;entryY=0.038;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-58" target="QSAenKkpdjQW8zQk9t1L-62" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="650" y="-175" as="sourcePoint" />
            <mxPoint x="809" y="260" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-67" value="queue_sched.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1670" y="-1970" width="340" height="236" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-68" value="&lt;b&gt;simple_round_robin(void* p)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="26" width="340" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-69" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="52" width="340" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-70" value="&lt;div&gt;while(1)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; cmd = &lt;b&gt;os_queue_head&lt;/b&gt;(q-&amp;gt;commandQueue)&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;commitCmdBuffer&lt;/b&gt;(cmd, &amp;amp;commitInfo)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;releaseCommandBuffer&lt;/b&gt;(cmd)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;os_queue_pop_head&lt;/b&gt;(q-&amp;gt;commandQueue)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="60" width="340" height="150" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-76" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="210" width="340" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-71" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1540" y="-1654" width="690" height="756" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-72" value="commitCmdBuffer(cmdBuffer_PTR cmd, commitInfo_PTR info)" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="26" width="690" height="24" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-73" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="50" width="690" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-74" value="gcsHAL_INTERFACE iface = { &lt;font color=&quot;#ff3333&quot;&gt;gcvHAL_COMMIT&lt;/font&gt;}&amp;nbsp;&lt;div&gt;gcsHAL_SUBCOMMIT subCommit[gcvCORE_COUNT+1] = {{0}}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;offset = processor-&amp;gt;commandBufferOffset&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//256&lt;/span&gt;&lt;/div&gt;&lt;div&gt;cmdTailSize = CMD_reservedTailSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//128&amp;nbsp; 8 * CORE_MAX_COUNT&lt;/div&gt;&lt;div&gt;cmdCount = getCommandCount(cmd);&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//162 host 已经准备的cmd&lt;/div&gt;&lt;div&gt;cmdSize&amp;nbsp; &amp;nbsp;= cmdCount*4 + CMD_reservedTailSize + CMD_reservedHeadSize //808&lt;br&gt;cmdSize = ALIGN_NP2(cmdSize, 64)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//832&lt;br&gt;cmdTailSize = cmdSize - cmdCount*4 - CMD_reservedHeadSize&amp;nbsp; &amp;nbsp;//152&lt;br&gt;cmdCount = cmdSize/4&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//208&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//之后还会align cmdSize到64再重新计算cmdTailSize&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//计算当前cmdCount, 再设置 cmdIdx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;commitIdx = processor-&amp;gt;commitCmdIdx&lt;/div&gt;&lt;div&gt;cmdIdx = commitIdx + totalCount&lt;br&gt;processor-&amp;gt;commitCmdIdx = cmdIdx&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//准备拷贝cmdBuffer_PTR中的cmd到 subCommit中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;readIdx = processor-&amp;gt;devReadCmdIdx&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;subCommit[i].commandBuffer.startOffset = offset;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//256&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;logical = getCPUAddr(processor-&amp;gt;commandBufferPool, processor) + offset; // cpu_logical&amp;nbsp; 55AD 21F6 3A00&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;dst = logical + CMD_reservedHeadSize;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// dst&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;55AD 21F6 3A20&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//拷贝host准备的cmd数据到 commandBufferPool当中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;memcpy(dst, cmd-&amp;gt;cmdBase, getCommandCount(cmd)*4)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;offset+= cmdSize&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iface.u.Commit.shared = !bDuplicate;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;subCommit[i].context = processor-&amp;gt;context[i]&amp;nbsp; //此处的context[i] 就是context db 的id&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.delta =0,&amp;nbsp; .queue = 0,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.address = getDeviceAddr(processor-&amp;gt;commandBufferPool. processor)&amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//FF7F E000&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.logical&amp;nbsp; &amp;nbsp; = getCPUAddr(processor-&amp;gt;commandBufferPool, processor)&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//55AD 21F6 3900&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.size&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; = cmdSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//832&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.reservedHead = CMD_reservedHeadSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//32&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.reservedTail = cmdTailSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//152&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.videoMemNode = processor-&amp;gt;commandBufferPool-&amp;gt;handle&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.entryPipe = gcvPIPE_3D , exitPipe = gcvPIPE_3D&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.exitIndex = &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;bDuplicate &lt;/span&gt;? 0 : 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.priority = 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;channelId &lt;/span&gt;= 1,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.next = subCommit + i + 1&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;iface.u.Commit.subCommit = subCommit[0]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;iface.u.Commit.broCoreMask = &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;broCoreMask&lt;/span&gt;&lt;br&gt;iface.cmmitMutex = false&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;KmdIoCtl(processor-&amp;gt;kmdHandle, IOCTL_GCHAL_INTERFACE, &amp;amp;iface, sizeof(iface) .....)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//iface.u.Commit.contextSwitched) 可以查询是否有context切换&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="58" width="690" height="672" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-77" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="730" width="690" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-75" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.49;exitY=1.023;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-76" target="QSAenKkpdjQW8zQk9t1L-71" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="1930" y="-2047" as="sourcePoint" />
            <mxPoint x="2050" y="-2264" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-78" value="gc_hal_kernel.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2400" y="-935" width="750" height="120" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-79" value="gckKERNEL_Dispatch(gckKERNEL kernel, gckDEVICE Device, gcsHAL_INTERFACE *Interface)&amp;nbsp;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-78" vertex="1">
          <mxGeometry y="26" width="750" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-80" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-78" vertex="1">
          <mxGeometry y="52" width="750" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-81" value="switch(Interface-&amp;gt;command)&lt;br&gt;case gcvHAL_COMMIT:&lt;br&gt;&amp;nbsp; &amp;nbsp; _Commit(Device, Kernel-&amp;gt;hardware-&amp;gt;type, Interface-&amp;gt;engine, processID, Interface-&amp;gt;u.Commit.broCoreMask, &amp;amp;Interface-&amp;gt;u.Commit)&amp;nbsp;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-78" vertex="1">
          <mxGeometry y="60" width="750" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-82" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-77" target="QSAenKkpdjQW8zQk9t1L-78" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2390" y="-505" as="sourcePoint" />
            <mxPoint x="2393" y="-416" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-84" value="gc_hal_kernel.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2400" y="-535" width="920" height="400" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-85" value="&lt;b&gt;_Commit(gckDEVICE Device, gceHARDWARE_TYPE HwType, gceENGINE Engine, gctUINT32 ProcessId, gctUNIT32 BroCoreMask, gcsHAL_COMMIT *Commit)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-84" vertex="1">
          <mxGeometry y="26" width="920" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-86" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-84" vertex="1">
          <mxGeometry y="52" width="920" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-87" value="&lt;div&gt;gckCOMMAND command;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gcsHAL_SUBCOMMIT *subCommit = &amp;amp;Commit-&amp;gt;subCommit;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;if (HwType == gcvHARDWARE_3D ...) {&lt;div&gt;&amp;nbsp; &amp;nbsp; kernel = Device-&amp;gt;coreInfoArray[subCommit-&amp;gt;coreId].kernel;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (Engine == gcvENGINE_BLT) { ... }&amp;nbsp;&lt;/div&gt;&lt;div&gt;else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;command = kernel-&amp;gt;command;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventObj&amp;nbsp; &amp;nbsp;= kernel-&amp;gt;eventObj;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckCOMMAND_Commit&lt;/b&gt;(command, subCommit, ProcessId, Commit-&amp;gt;shared, &amp;amp;Commit-&amp;gt;commitStamp, &amp;amp;Commit-&amp;gt;contextSwitched)&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckEVENT_Commit&lt;/b&gt;(eventObj, subCommit-&amp;gt;queue, false, command-&amp;gt;feType != gcvHW_FE_END, Commit-&amp;gt;shared)&lt;br&gt;&lt;br&gt;next = subCommit-&amp;gt;next;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-84" vertex="1">
          <mxGeometry y="60" width="920" height="340" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-1" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3590" y="-1049" width="830" height="590" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-2" value="&lt;b&gt;gckCOMMAND_Commit(gckCOMMAND Command, gcsHAL_SUBCOMMIT *SubCommit, ProcessId, Shared, CommitStamp, *contextSwitched)&lt;/b&gt;&lt;div&gt;&lt;b&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;CommitStamp //在提交命令后, 得到Command的commitStamp&lt;/span&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="U14mofKTcunZ6X7Fo2zi-1" vertex="1">
          <mxGeometry y="26" width="830" height="44" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-3" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="U14mofKTcunZ6X7Fo2zi-1" vertex="1">
          <mxGeometry y="70" width="830" height="8" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-4" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;gcsSTATE_DELTA_PTR delta = SubCommit-&amp;gt;delta&lt;br&gt;gckCONTEXT context = NULL;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gcsHAL_COMMAND_LOCATION *cmdLoc = &amp;amp;SubCommit-&amp;gt;commandBuffer;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;gckMMU mmu=NULL&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;if (SubCommit-&amp;gt;context)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;color: rgb(255, 51, 51);&quot;&gt;//通过kernel-&amp;gt;db-&amp;gt;pointerDatabase-&amp;gt;table[(UINT32_T)SubCommit-&amp;gt;context -1] 获取&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;&amp;nbsp; &amp;nbsp; context = gckKERNEL_QueryPointerFromName(Command-&amp;gt;kernel, SubCommit-&amp;gt;context)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;do {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; gckKERNEL_GetCurrentMMU(Command-&amp;gt;kernel, true, 0, &amp;amp;mmu) &lt;font color=&quot;#ff3333&quot;&gt;//???如何创建的???&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;kernel-&amp;gt;processPageTable &amp;amp;&amp;amp; &lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;Command-&amp;gt;currContext!=context&lt;/span&gt;)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;gckKERNEL_SwitchMMU(Command-&amp;gt;kernel, Shared, mmu)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#ff3333&quot;&gt;&amp;nbsp; &amp;nbsp; //获取power/Command 锁, 递增Command-&amp;gt;atomCommit&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; gckCOMMAND_EnterCommit&lt;/b&gt;(Command, false)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; _HandlePatchList(Command, cmdLoc, &amp;amp;pathListVar)&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;feType == gcvHW_FE_WAIT_LINK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;_CommitWaitLinkOnce&lt;/b&gt;(Command, context, cmdLoc, delta, ProcessId, Shared, contextSwitched, NULL, false, ...)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {....}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckCOMMAND_ExitCommit&lt;/b&gt;(Command, false)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; next = cmdLoc-&amp;gt;next&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; userPtr = next&lt;/div&gt;&lt;div&gt;} while(userPtr)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*CommitStamp = Command-&amp;gt;commitStamp&lt;br&gt;Command-&amp;gt;commitStamp++&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="U14mofKTcunZ6X7Fo2zi-1" vertex="1">
          <mxGeometry y="78" width="830" height="512" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-5" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.412;entryY=0.014;entryDx=0;entryDy=0;exitX=0.503;exitY=1.084;exitDx=0;exitDy=0;entryPerimeter=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-81" target="QSAenKkpdjQW8zQk9t1L-84" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2230" y="134" as="sourcePoint" />
            <mxPoint x="2380" y="-905" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-6" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4750" y="-1800" width="910" height="1544" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-7" value="_CommitWaitLinkOnce(gckCOMMAND Command, gckCONTEXT Context, gcsHAL_COMMAND_LOCATION *CommandBuffer, StateDelta, ProcessID, Shared, ....)" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="26" width="910" height="26" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-8" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="52" width="910" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-5" value="hardware = Command-&amp;gt;kernel-&amp;gt;hardware&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//查询 LINK 的大小(应为有LINK64或者LINK 两种link cmd)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //linkBytes = 16&lt;br&gt;&lt;/span&gt;&lt;b&gt;gckWLFE_Link&lt;/b&gt;(hardware, NULL, 0, 0, &amp;amp;&lt;b&gt;linkBytes&lt;/b&gt;, NULL, NULL)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//logical + CMD_ReservedHeadSize 就是KMD之前的用户cmds&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;commandBufferLogical&amp;nbsp;&lt;/b&gt;= CommandBuffer-&amp;gt;logical + CommandBuffer-&amp;gt;startOffset;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 55AD 21F6 3A00&amp;nbsp; &amp;nbsp;=&amp;nbsp; 55AD 21F6 3900&amp;nbsp; + 100 (256)&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;commandBufferAddress&amp;nbsp;&lt;/b&gt;= CommandBuffer-&amp;gt;address + CommandBuffer-&amp;gt;startOffset;&amp;nbsp; &amp;nbsp; &amp;nbsp; // FF7F E100&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; = FF7F E000 + 100&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//size就是KMD之前的用户cmds + reserved head + tail 对齐64的大小&lt;/span&gt;&lt;/div&gt;&lt;div&gt;commandBufferSize = CommandBuffer-&amp;gt;size;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// 832&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;gckCOMMAND_CheckFlushMMU(Command, hardware) //会根据情况刷MMU&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;if (Command-&amp;gt;kernel-&amp;gt;asyncCommand &amp;amp;&amp;amp; MaxAsyncTimeStamp!=0) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; _WaitForAsyncCommandStamp(Command, MaxAsyncTimeStamp)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//获取当前command queue 的offset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;offset = Command-&amp;gt;offset&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 144&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//获取当前kernel command queue 剩下的bytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;bytes = Command-&amp;gt;pageSize - offset&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 3952 = 4096 - offset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//查询 WAIT/LINK cmd 序列的大小，这里的offset是计算size时计算对齐地址用的&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_WaitLink&lt;/b&gt;(hw, NULL, INVALID_ADDR, offset, &amp;amp;&lt;b&gt;waitLinkBytes&lt;/b&gt;, NULL, NULL)&amp;nbsp; &amp;nbsp; &amp;nbsp;// waitLinkBytes = 32&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//检查kernel command queue 是否有足够的空间&lt;/span&gt;&lt;/div&gt;&lt;div&gt;if (bytes &amp;lt; waitLinkBytes) { ... }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Command Queue 的起始地址&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;waitLinkLogical&amp;nbsp;&lt;/b&gt;= Command-&amp;gt;logical + offset&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// 55AD 21ED 1890&amp;nbsp; = 55AD 21ED 1800 + 144&lt;/div&gt;&lt;div&gt;&lt;b&gt;waitLinkAddress&amp;nbsp;&lt;/b&gt;= Command-&amp;gt;address + offset&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//&amp;nbsp; &amp;nbsp;1FF FFFF F090&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=default;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;dashed=1;strokeWidth=2;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="60" width="910" height="470" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-2" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;//////////////////////////////////////////////////////////////////////////////////////////&lt;/span&gt;&lt;/div&gt;&lt;div&gt;if (Context == NULL) {&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;} else if (Command-&amp;gt;currContext != Context) {&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; ... //相同的context&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;///////////////////////////////////////////////////////////////////////////////////////////&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=default;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;dashed=1;strokeWidth=2;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="530" width="910" height="154" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-13" value="&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;newQueue) {...}&lt;br&gt;&amp;nbsp; &amp;nbsp; else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//设置之前Context Command Qeue的退出地址, 也就是新的Command的起始地址 一个 WAIT/LINK 序列&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;exitAddress&amp;nbsp;&lt;/b&gt;= waitLinkAddress;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;// 1FF FFFF F090&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;exitBytes&amp;nbsp;&lt;/b&gt;= waitLinkBytes;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//在Command queue的头上加入Wait/Link 序列, 暂时LOOP,&amp;nbsp; waitLinkLogical=55AD 21ED 1890&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;gckWLFE_WaitLink&lt;/b&gt;(hw, waitLinkLogical, waitLinkAddress, offset, &amp;amp;waitLinkBytes, &amp;amp;waitOffset, &amp;amp;waitSize)&amp;nbsp; &amp;nbsp; //会跟新 hw-&amp;gt;lastWaitLink = Address&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=default;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;dashed=1;strokeWidth=2;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="684" width="910" height="146" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-25" value="&lt;div&gt;&lt;span style=&quot;background-color: initial; color: rgba(0, 0, 0, 0); font-family: monospace; font-size: 0px; text-wrap-mode: nowrap;&quot;&gt;%3CmxGraphModel%3E%3Croot%3E%3CmxCell%20id%3D%220%22%2F%3E%3CmxCell%20id%3D%221%22%20parent%3D%220%22%2F%3E%3CmxCell%20id%3D%222%22%20value%3D%22Wait%22%20style%3D%22rounded%3D0%3BwhiteSpace%3Dwrap%3Bhtml%3D1%3B%22%20vertex%3D%221%22%20parent%3D%221%22%3E%3CmxGeometry%20x%3D%225880%22%20y%3D%22-1160%22%20width%3D%2290%22%20height%3D%2280%22%20as%3D%22geometry%22%2F%3E%3C%2FmxCell%3E%3C%2Froot%3E%3C%2FmxGraphModel%3&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font face=&quot;monospace&quot; color=&quot;rgba(0, 0, 0, 0)&quot;&gt;&lt;span style=&quot;font-size: 0px; text-wrap-mode: nowrap;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;newQueue) {...}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(.., Command-&amp;gt;videoMem, Command-&amp;gt;offset, waitLinkLogical,&amp;nbsp;&lt;b&gt;exitBytes&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//得到commandBuffer末尾的位置&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;commandBufferTail&lt;/b&gt;&amp;nbsp;= commandBufferLogical + commandBufferSize - CommandBuffer-&amp;gt;reservedTail&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// 55AD 21F6 3CA8 =&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;55AD 21F6 3A00 +&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;832 - 152&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; //生成写 commit stamp的 Fence cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;b&gt;gckHARDWARE_Fence&lt;/b&gt;(hw, gcvENGIN_RENDER, commandBufferTail, Command-&amp;gt;fence-&amp;gt;address, Command-&amp;gt;commitStamp, &amp;amp;fencebytes)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;commandBufferTail&amp;nbsp;&lt;/b&gt;+= fencebytes;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;55AD 21F6 3CC8 =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;55AD 21F6 3CA8 + 32&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=default;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;dashed=1;strokeWidth=2;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="830" width="910" height="210" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-6" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; if (Shared == false) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;gckWLFE_Link&lt;/b&gt;(hw,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferTail,&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//添加LINK 到command buffer 末尾&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;exitAddress,&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//LINK的地址就是 command buffer 的头, 之前在command buffer 头已经加上了WAIT/LINK序列&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;exitBytes, &amp;amp;linkBytes, &amp;amp;exitLinkLow, &amp;amp;exitLinkHight)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else { ...}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckVIDMEM_HANDLE_Lookup(); gckVIDMEM_NODE_CleanCache(); //查找commandBufferVideoMem, 并清除cache&lt;/div&gt;" style="text;strokeColor=default;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;dashed=1;strokeWidth=2;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="1040" width="910" height="150" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-11" value="&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Link到entryAddress, 此处的LINK会替换之前的WAIT/LINK 序列, 让整个Command 执行起来&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;gckWLFE_Link&lt;/b&gt;(hw, Command-&amp;gt;waitPos.logical,&amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//这个是之前Command Queue的Wait/Link 起始地址&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//55AD 21ED 1870&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entryAddress,&amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Link到 context-&amp;gt;buffer(如果有context)&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entryBytes,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;Command-&amp;gt;WaitPos.size,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;entryLinkLow, &amp;amp;entryLinkHigh)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(..., Command-&amp;gt;waitPos.videoMem, Command-&amp;gt;waitPos.offset, Command-&amp;gt;waitPos.logical...)&lt;/div&gt;" style="text;strokeColor=default;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;dashed=1;strokeWidth=2;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="1190" width="910" height="130" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-8" value="&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//更新当前 pipe&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;pipeSelect = CommandBuffer-&amp;gt;exitPipe&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;offset += waitLinkBytes;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// 新的offset 就是 176 = 144 + 32,&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;newQueue = false;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;//此处更新Command新的Wait/Link 地址&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPost.videoMem = Command-&amp;gt;videoMem;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.offset = Command-&amp;gt;offset - waitLinkBytes + waitOffset;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// 144 = 176 - 32 + 0&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.logical = waitLinkLogical + waitOffset&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 55AD 21ED 1890&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.address = waitLinkAddress + waitOffset;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// 1FF FFFF F090 + 0&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.size = waitSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//&amp;nbsp; 16&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;gckHARDWARE_UpdateQueueTail&lt;/b&gt;(hw, Command-&amp;gt;logical, Command-&amp;gt;offset)&lt;/div&gt;" style="text;strokeColor=default;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;dashed=1;strokeWidth=2;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="1320" width="910" height="224" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-10" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.999;exitY=0.292;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-87" target="U14mofKTcunZ6X7Fo2zi-1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2797" y="-355" as="sourcePoint" />
            <mxPoint x="2799" y="-285" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-11" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.003;entryY=0.186;entryDx=0;entryDy=0;exitX=1.001;exitY=0.147;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="U14mofKTcunZ6X7Fo2zi-4" target="U14mofKTcunZ6X7Fo2zi-7" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2881" y="58" as="sourcePoint" />
            <mxPoint x="2880" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-2" value="gc_hal_kernel_event.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3590" y="-230" width="810" height="190" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-3" value="&lt;b&gt;gckEVENT_Commit(gckEVENT Event, gcsQUEUE_PTR Queue, bool Forced, bool Submit, bool Shared)&amp;nbsp;&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="UbzL_sldVN1qwGkXepIT-2" vertex="1">
          <mxGeometry y="26" width="810" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-4" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="UbzL_sldVN1qwGkXepIT-2" vertex="1">
          <mxGeometry y="52" width="810" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-5" value="if (Submit) {&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.wait = true&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.shared = Shared&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.fromPower = false&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.broadcase = true&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckEVENT_Submit(Event, &amp;amp;eventAttr)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="UbzL_sldVN1qwGkXepIT-2" vertex="1">
          <mxGeometry y="60" width="810" height="130" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-7" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.996;exitY=0.842;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-87" target="UbzL_sldVN1qwGkXepIT-2" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="3339" y="-145" as="sourcePoint" />
            <mxPoint x="3570" y="-610" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-8" value="gc_hal_kernel_event.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4520" y="-20" width="540" height="778" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-9" value="&lt;b style=&quot;&quot;&gt;gckEVENT_Submit(gckEVENT Event, gckEVENT_PTR EventAttr)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="UbzL_sldVN1qwGkXepIT-8" vertex="1">
          <mxGeometry y="26" width="540" height="24" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-11" value="command = Event-&amp;gt;command &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//command 也是 kernel-&amp;gt;command&lt;/span&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;queue &lt;/b&gt;= Event-&amp;gt;queueHead &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//Event-&amp;gt;queues 中的 head(queues 是数组 29个)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//获取当前 commit stamp &lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;(已经被加1)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;commitStamp &lt;/b&gt;= command-&amp;gt;commitStamp&lt;/div&gt;&lt;div&gt;if (commitStamp)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; commitStamp -= 1&amp;nbsp; //已经被加1???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//分配event ID&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckEVENT_GetEvent&lt;/b&gt;(Event, wait, &lt;b&gt;&amp;amp;id&lt;/b&gt;, queue-&amp;gt;source)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//event ID queue 指向 event list&lt;/span&gt;&lt;/div&gt;&lt;div&gt;Event-&amp;gt;queue[id].head = queue-&amp;gt;head&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//更新commitStamp&lt;/span&gt;&lt;/div&gt;&lt;div&gt;Event-&amp;gt;queue[id].commitStamp = commitStamp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//把当前queue 从Event-&amp;gt;queueHead中移除&lt;br&gt;...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (command-&amp;gt;feType == gcvHW_FE_WAIT_LINK || command-&amp;gt;feType == gcvHW_FE_END) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; _QueryFlush(..., &amp;amp;flush) &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取需要Flush的内容&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckWLFE_Event(hw, NULL, id, Event-&amp;gt;queue[id].source, &amp;amp;bytes) //bytes : 32&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckHARDWARE_Flush(hw, flush, NULL, &amp;amp;flushBytes)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bytes += flushBytes&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;executeBytes = bytes&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Command Qeuue 里面预留空间&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;gckCOMMAND_Reserve(command, bytes, &amp;amp;buffer, &amp;amp;bytes) //3920&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (command-&amp;gt;feType == gcvHW_FE_WAIT_LINK || command-&amp;gt;feType == gcvHW_FE_END) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; //添加flush cmd 到command queue&lt;br&gt;&amp;nbsp; &amp;nbsp; gckHARDWARE_Flush(hw, flush, buffer, &amp;amp;flushBytes)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; buffer = buffer + flushBytes;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckWLFE_Event&lt;/b&gt;(hw, buffer, id, Event-&amp;gt;queues[id].source, &amp;amp;bytes)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(command-&amp;gt;feType == gcvHW_FE_WAIT_LINK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gckCOMMAND_Execute(command, executeBytes)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckCOMMAND_ExitCommit(command, fromPower)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="UbzL_sldVN1qwGkXepIT-8" vertex="1">
          <mxGeometry y="50" width="540" height="720" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-10" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="UbzL_sldVN1qwGkXepIT-8" vertex="1">
          <mxGeometry y="770" width="540" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-12" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" parent="1" source="UbzL_sldVN1qwGkXepIT-5" target="UbzL_sldVN1qwGkXepIT-8" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="4300" y="1039" as="sourcePoint" />
            <mxPoint x="4602" y="300" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-13" value="gc_hal_kernel_hardware_waitlink_fe.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5180" y="60" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-14" value="gckWLFE_Event(hw, Logical, uint8 Event, FromWhere, *Bytes)" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="UbzL_sldVN1qwGkXepIT-13" vertex="1">
          <mxGeometry y="26" width="400" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-15" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="UbzL_sldVN1qwGkXepIT-13" vertex="1">
          <mxGeometry y="52" width="400" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-16" value="&lt;div&gt;if(blt) {&lt;/div&gt;&amp;nbsp; &amp;nbsp; *logical++ = LOAD_STATE gcregBltGeneralControlRegAddrs&lt;div&gt;&amp;nbsp; &amp;nbsp; *logical++ = LOCK&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (multiCluster) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; *logical++ = LOAD_STATE gcregBltClusterControlRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; *logical++ = hw-&amp;gt;options.userClusterMask&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*logical++ = LOAD_STATE AQEventRegAddrs&lt;/div&gt;&lt;div&gt;*logical++ = Event (EVENT_ID)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if(blt) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *logical++ = LOAD_STATE gcregBltGeneralControlRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; *logical++ = UNLOCK&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="UbzL_sldVN1qwGkXepIT-13" vertex="1">
          <mxGeometry y="60" width="400" height="260" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-17" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5180" y="530" width="500" height="740" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-18" value="&lt;b&gt;gckCOMMAND_Execute(gckCOMMAND Command, uint32 RequestedBytes)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="UbzL_sldVN1qwGkXepIT-17" vertex="1">
          <mxGeometry y="26" width="500" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-19" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="UbzL_sldVN1qwGkXepIT-17" vertex="1">
          <mxGeometry y="52" width="500" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-20" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//计算 WAIT/LINK的offset&lt;/span&gt;&lt;/div&gt;waitLinkOffset = Command-&amp;gt;offset + RequestedBytes&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//计算Command queue 剩余字节&lt;/span&gt;&lt;/div&gt;&lt;div&gt;waitLinkBytes = Command-&amp;gt;pageSize - waitLinkOffset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//计算 WAIT/LINK 序列的位置&lt;/span&gt;&lt;/div&gt;&lt;div&gt;waitLinkLogical = Command-&amp;gt;logical + waitLinkOffset;&lt;/div&gt;&lt;div&gt;waitLinkAddress = Command-&amp;gt;address + waitLinkOffset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//添加 WAIT/LINK 到command queue&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckWLFE_WaitLink(hw, waitLinkLogical,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkAddress&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkOffset,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkBytes,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitOffset, waitBytes)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (Command-&amp;gt;newQueue) { ...}&lt;/div&gt;&lt;div&gt;else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; execLogical = Command-&amp;gt;logical + Command-&amp;gt;offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; execAddress = Command-&amp;gt;address + Command-&amp;gt;offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; execBytes = RequestedBytes + waitLinkBytes&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(...)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gckWLFE_Link(hw, Command-&amp;gt;waitPos.logical,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; execAddress, execBytes,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;Command-&amp;gt;waitPos,size,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;linkLow, &amp;amp;linkHight)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckVIDMEM_NODE_CleanCache(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//更新到最后一个WAIT&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.videoMem = Command-&amp;gt;videoMem&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.offset = waitLinkOffset + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.logical = waitLinkLogical + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.address = waitLinkAddress + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.size = waitBytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//更新command queue&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;offset += RequestedBytes + waitLinkBytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;newQueue =false&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckHARDWARE_UpdateQueueTail(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="UbzL_sldVN1qwGkXepIT-17" vertex="1">
          <mxGeometry y="60" width="500" height="680" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-21" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=0.992;exitY=0.23;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="UbzL_sldVN1qwGkXepIT-11" target="UbzL_sldVN1qwGkXepIT-13" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="4000" y="45" as="sourcePoint" />
            <mxPoint x="4530" y="1" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-22" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=1.001;exitY=0.687;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="UbzL_sldVN1qwGkXepIT-11" target="UbzL_sldVN1qwGkXepIT-17" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="5185" y="232" as="sourcePoint" />
            <mxPoint x="5370" y="-60" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-25" value="createCommandBufferPool(processor_PTR processor)&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;processor-&amp;gt;commandBufferOffset = 256&lt;/div&gt;" style="html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="1120" y="-1605" width="370" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-26" value="" style="endArrow=classic;html=1;rounded=0;entryX=-0.005;entryY=0.087;entryDx=0;entryDy=0;entryPerimeter=0;exitX=1;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UbzL_sldVN1qwGkXepIT-25" target="QSAenKkpdjQW8zQk9t1L-74" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1390" y="-1525" as="sourcePoint" />
            <mxPoint x="1440" y="-1575" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-27" value="ENV" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="10360" y="-541" width="270" height="86" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-28" value="VIV_CUDA_DRV_PROFILE" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="UbzL_sldVN1qwGkXepIT-27" vertex="1">
          <mxGeometry y="26" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-29" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="UbzL_sldVN1qwGkXepIT-27" vertex="1">
          <mxGeometry y="52" width="270" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-30" value="+ method(type): type" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="UbzL_sldVN1qwGkXepIT-27" vertex="1">
          <mxGeometry y="60" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-31" value="&lt;div&gt;&lt;b&gt;iniDriver()-&amp;gt;createProcessor()--&amp;gt;attachToKMD&lt;/b&gt;&lt;/div&gt;&lt;div&gt;--&amp;gt; iface = {gcvHAL_ATTACH}&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; for (int i=0; i&amp;lt;processor-&amp;gt;coreCount; i++) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;KmdIoCtrl(...)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;processor-&amp;gt;context[i] = iface.u.Attach.context (一个数字ID)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;...&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;processor-&amp;gt;contextBytes = iface.u.Attach.bytes&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;processor-&amp;gt;contextLogical[2*i + 0] = iface.u.Attach.logicals[0]&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;processor-&amp;gt;contextLogical[2*i + 0] = iface.u.Attach.logicals[1]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="1120" y="-1390" width="370" height="160" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-32" value="" style="endArrow=classic;html=1;rounded=0;entryX=-0.002;entryY=0.604;entryDx=0;entryDy=0;entryPerimeter=0;exitX=1;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UbzL_sldVN1qwGkXepIT-31" target="QSAenKkpdjQW8zQk9t1L-74" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1490" y="-1580" as="sourcePoint" />
            <mxPoint x="1547" y="-1528" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-33" value="attachToKMD-&amp;gt;gckKERNEL_Dispatch()-&amp;gt;gckKERNEL_AllocateNameFromPointer()&lt;br&gt;--&amp;gt; gckKERNEL_AllocateIntegerId(...)" style="html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="2930" y="-1170" width="465" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-34" value="" style="endArrow=classic;html=1;rounded=0;entryX=-0.001;entryY=0.202;entryDx=0;entryDy=0;entryPerimeter=0;exitX=1;exitY=1;exitDx=0;exitDy=0;" parent="1" source="UbzL_sldVN1qwGkXepIT-33" target="U14mofKTcunZ6X7Fo2zi-4" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2510" y="-1340" as="sourcePoint" />
            <mxPoint x="2562" y="-1331" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-42" value="ResvHead&lt;br&gt;32" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2430" y="-1310" width="100" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-43" value="StartOffset&lt;br&gt;256" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2320" y="-1310" width="110" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-44" value="832" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;align=center;" parent="1" vertex="1">
          <mxGeometry x="2530" y="-1310" width="410" height="80" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-40" value="User Commands&lt;br&gt;648 (162*4)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2530" y="-1270" width="260" height="40" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-1" value="ResvTail&lt;br&gt;128-&amp;gt;152" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2790" y="-1270" width="130" height="40" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-3" value="Next" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2940" y="-1310" width="120" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-4" value="ResvHead&amp;nbsp;32" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="5995" y="-1330" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-5" value="StartOffset&lt;br&gt;256" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5880" y="-1330" width="115" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-6" value="832" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;align=center;" parent="1" vertex="1">
          <mxGeometry x="6355" y="-1330" width="410" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-7" value="User Commands&lt;br&gt;648 (162*4)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="6355" y="-1290" width="260" height="40" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-8" value="ResvTail&lt;br&gt;128-&amp;gt;152" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6615" y="-1290" width="130" height="40" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-9" value="Command Buffer&lt;br&gt;Next" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="6765" y="-1330" width="130" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-10" value="Context Switch" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="7470" y="-1838" width="740" height="538" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-11" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;&amp;nbsp; &amp;nbsp; contextBuffer = Context-&amp;gt;buffer;&lt;br&gt;&amp;nbsp; &amp;nbsp; //合并delta 数据到context buffer&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;&amp;nbsp; &amp;nbsp; gckCONTEXT_Update(Context, ProcessID, StateDelta)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&amp;nbsp; &amp;nbsp; //得到 context buffer 的 entry offset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; offset = (Command-&amp;gt;pipeSelect == gcvPIP_3D) ?&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Context-&amp;gt;entryOffset3D + Context-&amp;gt;pipSelectBytes&amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//+8 就是跳过 pipe switching sequence&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : Context-&amp;gt;entryOffset3D&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //不跳过 pipe switching sequence&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//得到context buffer 的起始地址与大小&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; entryLogical = contextBuffer-&amp;gt;logical + offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; entryAddress = contextBuffer-&amp;gt;address + offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; entryBytes = Context-&amp;gt;bufferSize - offset&amp;nbsp; //&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//检查是否需要添加切换pipe的cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (CommandBuffer-&amp;gt;entryPipe == gcvPIPE_3D) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//跳过切换pipe的预留cmd长度&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; offset = CommandBuffer-&amp;gt;reservedHead&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//通过 gckHARDWARE_PipeSelect(...) 添加切换pipe的cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//通过 contextBuffer link3D的位置 LINK 到 commandBuffer + offset(就是command buffer 的起始)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;gckWLFE_Link&lt;/b&gt;(hw,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;contextBuffer-&amp;gt;link3D,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferAddress + offset,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferSize - offset,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;amp;linkBytes, &amp;amp;commandLinkLow, &amp;amp;commandLinkHigh)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;gckVIDMEM_NODE_CleanCache&lt;/b&gt;(..., contextBuffer-&amp;gt;videoMem, (entryAddress - contextBuffer-&amp;gt;address), entryLogical,&amp;nbsp;&lt;b&gt;entryBytes&lt;/b&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//切换context&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;currContext = Context;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *contextSwitched = true;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="HmzNs-rwB6UDGuZFhDU5-10" vertex="1">
          <mxGeometry y="26" width="740" height="504" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-12" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="HmzNs-rwB6UDGuZFhDU5-10" vertex="1">
          <mxGeometry y="530" width="740" height="8" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-16" value="No Context" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5840" y="-1830" width="740" height="298" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-17" value="if(CommandBuffer-&amp;gt;entryPipe == Command-&amp;gt;pipeSelect {&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;offset &lt;/b&gt;= CommandBuffer-&amp;gt;reservedHead;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 32, 此吃offset 就是跳过switch pipe的cmd&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; pipeBytes = CommandBuffer-&amp;gt;reservedHead;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 32&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//需要切换Pipe&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckHARDWARE_PipeSelect&lt;/b&gt;(hw,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; commandBufferLogical,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; CommandBuffer-&amp;gt;entryPipe, &amp;amp;pipeBytes)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;offset &lt;/b&gt;= 0; //就是指向reservedHead头&lt;/div&gt;&lt;div&gt;}&lt;br&gt;&lt;span style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;//entry 都是command Buffer 的地址&lt;br&gt;&lt;/span&gt;&lt;b&gt;entryLogical &lt;/b&gt;= commandBufferLogical + offset;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 55AD 21F6 3A00&amp;nbsp; + 0/32&lt;br&gt;&lt;b&gt;entryAddress &lt;/b&gt;= commandBufferAddress + offset;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // FF7F E100&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; + 0/32&lt;br&gt;&lt;b&gt;entryBytes &lt;/b&gt;= commandBufferSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // 832&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; - 0/32&lt;br&gt;Command-&amp;gt;currContext = NULL&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="HmzNs-rwB6UDGuZFhDU5-16" vertex="1">
          <mxGeometry y="26" width="740" height="264" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-18" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="HmzNs-rwB6UDGuZFhDU5-16" vertex="1">
          <mxGeometry y="290" width="740" height="8" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-20" value="LoadState&lt;div&gt;flush, Sema&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="5995" y="-1300" width="90" height="50" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-21" value="STALL" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6175" y="-1300" width="90" height="50" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-22" value="LoadState&lt;br&gt;PipeSel" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6265" y="-1300" width="90" height="50" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-23" value="LoadState&lt;div&gt;Semaphore&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6085" y="-1300" width="90" height="50" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-24" value="ResvHead&amp;nbsp;32" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="5990" y="-960" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-25" value="StartOffset&lt;br&gt;256" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5880" y="-960" width="110" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-26" value="832" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;align=center;" parent="1" vertex="1">
          <mxGeometry x="6350" y="-960" width="735" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-27" value="User Commands&lt;br&gt;648 (162*4)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="6350" y="-930" width="260" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-28" value="ResvTail 128-&amp;gt;152" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="6610" y="-930" width="455" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-29" value="Command Buffer&lt;br&gt;Next" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="7085" y="-960" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-30" value="LoadState&lt;div&gt;flush, Sema&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5990" y="-930" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-31" value="STALL" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6170" y="-930" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-32" value="LoadState&lt;br&gt;PipeSel" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6260" y="-930" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-33" value="LoadState&lt;div&gt;Semaphore&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6080" y="-930" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-34" value="Command Queue" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="5885" y="-1160" width="775" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-35" value="offset&amp;nbsp;&lt;br&gt;144" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="5840" y="-1160" width="180" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-36" value="switch pipe" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.496;exitY=0.319;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="HmzNs-rwB6UDGuZFhDU5-18" target="HmzNs-rwB6UDGuZFhDU5-5" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="4620" y="-1970" as="sourcePoint" />
            <mxPoint x="4682" y="-2150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-37" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-13" target="HmzNs-rwB6UDGuZFhDU5-35" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="5660" y="-1410" as="sourcePoint" />
            <mxPoint x="5770" y="-1092" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-38" value="Wait" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="6020" y="-1160" width="90" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-39" value="Link" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="6110" y="-1160" width="90" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-40" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;strokeWidth=5;" parent="1" source="HmzNs-rwB6UDGuZFhDU5-39" target="HmzNs-rwB6UDGuZFhDU5-38" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="6130" y="-1180" as="sourcePoint" />
            <mxPoint x="6180" y="-1230" as="targetPoint" />
            <Array as="points">
              <mxPoint x="6155" y="-1210" />
              <mxPoint x="6020" y="-1210" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-51" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-25" target="HmzNs-rwB6UDGuZFhDU5-25" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="5662.730000000001" y="-1332.7800000000002" as="sourcePoint" />
            <mxPoint x="5755" y="-829" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-52" value="LoadState&lt;br&gt;fenceHiAddr" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6610" y="-900" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-53" value="LoadState&lt;br&gt;fenceAddr" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6685" y="-900" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-54" value="LoadState&lt;br&gt;fenceDataH" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6760" y="-900" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-55" value="LoadState&lt;br&gt;fenceDataL" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6835" y="-900" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-56" value="ResvHead&amp;nbsp;32" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="5990" y="-770" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-57" value="StartOffset&lt;br&gt;256" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5880" y="-770" width="110" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-58" value="832" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;align=center;" parent="1" vertex="1">
          <mxGeometry x="6350" y="-770" width="735" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-59" value="User Commands&lt;br&gt;648 (162*4)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="6350" y="-740" width="260" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-60" value="ResvTail 128-&amp;gt;152" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="6610" y="-740" width="455" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-61" value="Command Buffer&lt;br&gt;Next" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="7085" y="-770" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-62" value="LoadState&lt;div&gt;flush, Sema&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5990" y="-740" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-63" value="STALL" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6170" y="-740" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-64" value="LoadState&lt;br&gt;PipeSel" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6260" y="-740" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-65" value="LoadState&lt;div&gt;Semaphore&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6080" y="-740" width="90" height="90" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-66" value="LoadState&lt;br&gt;fenceHiAddr" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6610" y="-710" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-67" value="LoadState&lt;br&gt;fenceAddr" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6685" y="-710" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-68" value="LoadState&lt;br&gt;fenceDataH" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6760" y="-710" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-69" value="LoadState&lt;br&gt;fenceDataL" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="6835" y="-710" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-70" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-6" target="HmzNs-rwB6UDGuZFhDU5-57" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="5661.8200000000015" y="-1281.9600000000003" as="sourcePoint" />
            <mxPoint x="5750" y="-950" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-71" value="LINK" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="6910" y="-710" width="75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-72" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;strokeWidth=5;" parent="1" source="HmzNs-rwB6UDGuZFhDU5-71" target="HmzNs-rwB6UDGuZFhDU5-38" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="6985" y="-1050" as="sourcePoint" />
            <mxPoint x="6850" y="-1050" as="targetPoint" />
            <Array as="points">
              <mxPoint x="6950" y="-1040" />
              <mxPoint x="6020" y="-1040" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-73" value="Command Queue" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="5880" y="-560" width="775" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-74" value="offset&amp;nbsp;&lt;br&gt;144" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;verticalAlign=top;align=left;" parent="1" vertex="1">
          <mxGeometry x="5840" y="-560" width="175" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-75" value="Wait" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="6015" y="-560" width="90" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-76" value="Link" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="6105" y="-560" width="90" height="80" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-77" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-11" target="HmzNs-rwB6UDGuZFhDU5-74" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="5658.18" y="-1225.2000000000003" as="sourcePoint" />
            <mxPoint x="5890" y="-760" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-78" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;strokeWidth=5;" parent="1" source="HmzNs-rwB6UDGuZFhDU5-71" target="HmzNs-rwB6UDGuZFhDU5-75" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="6958" y="-700" as="sourcePoint" />
            <mxPoint x="6030" y="-1070" as="targetPoint" />
            <Array as="points">
              <mxPoint x="6948" y="-430" />
              <mxPoint x="6015" y="-430" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-79" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;strokeWidth=5;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="6150" y="-560" as="sourcePoint" />
            <mxPoint x="6015" y="-560" as="targetPoint" />
            <Array as="points">
              <mxPoint x="6150" y="-610" />
              <mxPoint x="6015" y="-610" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-80" value="LINK" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;" parent="1" vertex="1">
          <mxGeometry x="5910" y="-530" width="70" height="50" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-81" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;strokeWidth=5;entryX=0;entryY=1;entryDx=0;entryDy=0;" parent="1" source="HmzNs-rwB6UDGuZFhDU5-80" target="HmzNs-rwB6UDGuZFhDU5-62" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="5995" y="-250" as="sourcePoint" />
            <mxPoint x="6410" y="-230" as="targetPoint" />
            <Array as="points">
              <mxPoint x="5945" y="-600" />
              <mxPoint x="5990" y="-600" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-82" value="" style="endArrow=classic;html=1;rounded=0;entryX=0.406;entryY=1.041;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" target="HmzNs-rwB6UDGuZFhDU5-73" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="5662" y="-390" as="sourcePoint" />
            <mxPoint x="5710" y="-520" as="targetPoint" />
            <Array as="points">
              <mxPoint x="6040" y="-390" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-83" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;新的 Command-&amp;gt;offset&amp;nbsp;&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="HmzNs-rwB6UDGuZFhDU5-82" vertex="1" connectable="0">
          <mxGeometry x="-0.0742" y="5" relative="1" as="geometry">
            <mxPoint x="-99" y="5" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-85" value="Start Address&lt;br&gt;&lt;span style=&quot;text-align: left;&quot;&gt;55AD 21ED 1800&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5840" y="-1220" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-86" value="Start Address&lt;br&gt;&lt;span style=&quot;text-align: left;&quot;&gt;55AD 21ED 1870&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="5910" y="-480" width="70" height="60" as="geometry" />
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-87" value="" style="endArrow=classic;html=1;rounded=0;exitX=1.001;exitY=0.629;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-8" target="HmzNs-rwB6UDGuZFhDU5-75" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="5665.460000000001" y="-1107.7200000000003" as="sourcePoint" />
            <mxPoint x="6010" y="-480" as="targetPoint" />
            <Array as="points">
              <mxPoint x="5960" y="-340" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="HmzNs-rwB6UDGuZFhDU5-88" value="&lt;font style=&quot;font-size: 14px;&quot;&gt;新的 Command-&amp;gt;waitPos.logical&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="HmzNs-rwB6UDGuZFhDU5-87" vertex="1" connectable="0">
          <mxGeometry x="-0.0742" y="5" relative="1" as="geometry">
            <mxPoint x="-49" y="3" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-26" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-2" target="HmzNs-rwB6UDGuZFhDU5-16" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="5670" y="-1033" as="sourcePoint" />
            <mxPoint x="5850" y="-1150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-27" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-280" y="-6390" width="770" height="830" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-28" value="&lt;b&gt;gckCOMMAND_Construct(Kernel, FeType, *Command)&lt;/b&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-27" vertex="1">
          <mxGeometry y="26" width="770" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-29" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-27" vertex="1">
          <mxGeometry y="52" width="770" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-30" value="&lt;b&gt;gckOS_Allocate&lt;/b&gt;(os, sizeof(_gckCOMMAND), &amp;amp;pointer)&amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//vmalloc 或者 kmalloc&lt;/span&gt;&lt;div&gt;command = pointer&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckOS_ZeroMemory(command, ...)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//memset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;command-&amp;gt;object.type = gcvOBJ_COMMAND, kernel = kernel, os =os&lt;br&gt;command-&amp;gt;feType = Fetype&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//查询command-&amp;gt;alignment = 8 bytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckHARDWARE_QueryCommandBuffer&lt;/b&gt;(hw, gcvENGINE_RENDER, &amp;amp;command-&amp;gt;alignment, NULL,NULL)&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//create mutex semaphre&lt;/span&gt;&lt;br&gt;command-&amp;gt;mutexQueue, mutexContext, mutexContexSeq, powerSemaphore, &lt;b&gt;atomCommit&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取OS pageSize&lt;/span&gt;&lt;br&gt;&lt;b&gt;gckOS_GetPageSize&lt;/b&gt;(os, &amp;amp;pageSize)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取PID&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckOS_GetProcesID&lt;/b&gt;(&amp;amp;command-&amp;gt;kernelProcessID)&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//getpid()&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//设置默认 pipe 0&lt;br&gt;&lt;/span&gt;command-&amp;gt;pipeSelecte = gcvPIPE_INVALID&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//预先分配 command queue:&amp;nbsp; 2个queue&lt;/span&gt;&lt;/div&gt;&lt;div&gt;for(i=0; i &amp;lt; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;gcdCOMMAND_QUEUE&lt;/span&gt;; ++i) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; pool = gcvPOOL_DEFAULT&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; size = pageSize&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; videoMem = NULL&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; allocFlag = 0 // gcvALLOC_FLAG_CACHEABLE&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//为command buffer 分配 显存&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;b&gt;gckKERNEL_AllocateVideoMemory&lt;/b&gt;(Kernel, 64, gcvVIDMEM_TYPE_COMMAND, allocFlag, &amp;amp;size, &amp;amp;pool, &amp;amp;videoMem)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; command-&amp;gt;queue[i].videoMem = videoMem&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; command-&amp;gt;queue[i].pool = pool&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//为GPU LOCK&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;b&gt;gckVIDMEM_NODE_Lock&lt;/b&gt;(Kernel, videoMem, &amp;amp;command-&amp;gt;queues[i].address)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//为CPU LOCK&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;b&gt;gckVIDMEM_LockCPU&lt;/b&gt;(Kernel, videoMem, false, false, &amp;amp;command-&amp;gt;queues[i].logical)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckOS_CreateSignal&lt;/b&gt;(os, false, &amp;amp;command-&amp;gt;queues[i].signal)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckOS_Signal&lt;/b&gt;(os, command-&amp;gt;queues[i].signal, true)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//分配fence, fence同样分配为LOCK CPU&amp;amp;GPU的显存(8个字节)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckFENCE_Create&lt;/b&gt;(os,Kernel, &amp;amp;command-&amp;gt;fence)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;command-&amp;gt;index = -1,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;logical = null,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;newQueue = false&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (FeType == gcvHW_FE_MULTI_CHANNEL) { ... }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;command-&amp;gt;running = false, idle = true, &lt;b&gt;commitStamp = 1 &lt;/b&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//stamp 从1开始&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*Command = command&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-27" vertex="1">
          <mxGeometry y="60" width="770" height="770" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-31" value="gc_hal_kernel.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-1300" y="-4890" width="510" height="380" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-32" value="&lt;b&gt;gckKERNEL_Construct(Os, Core, ChipID, Context, Device, SharedDB, *Kernel)&lt;/b&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="26" width="510" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-33" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="52" width="510" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-34" value="+ method(type): type" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="60" width="510" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-35" value="&lt;b&gt;gckCOMMAND_Construct&lt;/b&gt;(kernel, feType, &amp;amp;kernel-&amp;gt;command)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="86" width="510" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-37" value="&lt;b&gt;gckEVENT_Construct&lt;/b&gt;(kernel, kernel-&amp;gt;asyncCommand, &amp;amp;kernel-&amp;gt;asyncEvent)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="112" width="510" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-38" value="+ method(type): type" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="138" width="510" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-39" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//设置MMU 相关&lt;/span&gt;&lt;/div&gt;&lt;b&gt;gckHARDWARE_PostConstruct&lt;/b&gt;(kernel-&amp;gt;hardware)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="164" width="510" height="46" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-40" value="&lt;b&gt;gckHARDWARE_InitializeHardware&lt;/b&gt;(kernel-&amp;gt;hardware)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="210" width="510" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-55" value="if (kernel-&amp;gt;command) &lt;b&gt;gckCOMMAND_Start&lt;/b&gt;(kernel-&amp;gt;command)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="236" width="510" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-66" value="&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//和profiler 相关的设置&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;kernel-&amp;gt;profiler.profilerEnable = false&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;....&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;gckOS_CreateTimer(..., &amp;amp;kernel-&amp;gt;monitorTimer)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;gckOS_StartTimer(... kernel-&amp;gt;monitorTimer, 100)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;if (kernel-&amp;gt;processPageTable) { ..}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-31" vertex="1">
          <mxGeometry y="262" width="510" height="118" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-36" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-35" target="XHSnjxVOCnQZ8cdE8w61-27" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-650" y="-4893" as="sourcePoint" />
            <mxPoint x="-520" y="-5110" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-41" value="gc_hal_kernel_hardware.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-280" y="-5490" width="430" height="230" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-42" value="&lt;span style=&quot;font-weight: 700; text-align: center;&quot;&gt;gckHARDWARE_PostConstruct(Hardware)&lt;/span&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-41" vertex="1">
          <mxGeometry y="26" width="430" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-43" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-41" vertex="1">
          <mxGeometry y="52" width="430" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-44" value="if (Hardware-&amp;gt;options.enableMMU) {&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;_InitPageTableArray(Hardware)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//此处有两个execution 一个是MMU 一个是FLUSH&lt;/span&gt;&lt;/div&gt;&lt;div&gt;for (i =0; i&amp;lt;gcvFUNCTION_EXECUTION_NUM; i++) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckFUNCTION_Validate(&amp;amp;Hardware-&amp;gt;functions[i], &amp;amp;funcValid)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (funcValid) gckFUNCTION_Init(&amp;amp;Hardware-&amp;gt;functions[i])&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-41" vertex="1">
          <mxGeometry y="60" width="430" height="170" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-49" value="gc_hal_kernel_hardware.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="300" y="-5490" width="420" height="210" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-50" value="&lt;b&gt;_FuncInit_MMU(gcsFUNCTION_EXECUTION_PTR Execution)&lt;/b&gt;" style="text;strokeColor=#b85450;fillColor=#f8cecc;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-49" vertex="1">
          <mxGeometry y="26" width="420" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-51" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-49" vertex="1">
          <mxGeometry y="52" width="420" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-52" value="f&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-49" vertex="1">
          <mxGeometry y="60" width="420" height="150" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-53" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-44" target="XHSnjxVOCnQZ8cdE8w61-49" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-510" y="-5541" as="sourcePoint" />
            <mxPoint x="-250" y="-6110" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-54" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-39" target="XHSnjxVOCnQZ8cdE8w61-41" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-650" y="-4301" as="sourcePoint" />
            <mxPoint x="-390" y="-4870" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-56" value="gc_hal_kernel_hardware.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-280" y="-5160" width="670" height="1220" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-57" value="&lt;b&gt;gckHARDWARE_InitializeHardware&lt;/b&gt;(gckHARDARE Hardware)" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-56" vertex="1">
          <mxGeometry y="26" width="670" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-58" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-56" vertex="1">
          <mxGeometry y="52" width="670" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-59" value="gckOS_ReadRegisterEx(AQ_HI_CLOCK_CONTROL_Address)&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;// Disable isolate GPU bit&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(AQ_HI_CLOCK_CONTROL_Address, ISOLATE_GPU=0)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;// 读回&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckOS_ReadRegisterEx(AQ_HI_CLOCK_CONTROL_Address, ..)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;// Enable debug&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(AQ_HI_CLOCK_CONTROL_Address, DISABLE_DEBUG_REGISTER = 0)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//如果 security_ahb 支持并且 hw-&amp;gt;options.secureMode=gcvSECURE_IN_NORMAL&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(GCREG_HI_AHB_CONTROL_Address, DEBUG_MODE=1)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//Reset Memory counters&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(GC_RESET_MEM_COUNTERS_Address, ~0)&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(GC_RESET_MEM_COUNTERS_Address, 0)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;data |= GCREG_AXI_AHB_CONFIG, AWCACHE, 0x3&lt;/div&gt;&lt;div&gt;data |= GCREG_AXI_AHB_CONFIG, AWCACHE_OVERRIDE_SHARED, 0x3&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(GCREG_AXI_AHB_CONFIG_Address, data)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//Enable clock gating&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckOS_ReadRegisterEx(hw-&amp;gt;powerBaseAddress + GC_MODULE_POWER_CONTROLS_Address, &amp;amp;data)&lt;/div&gt;&lt;div&gt;data = GC_MODULE_POWER_CONTROLS, ENABLE_MODULE_CLOCK_GATING 1&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;gckOS_WriteRegisterEx(hw-&amp;gt;powerBaseAddress + GC_MODULE_POWER_CONTROLS_Address, data)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//Initialize FE&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&lt;b style=&quot;&quot;&gt;gckWLFE_Initialize&lt;/b&gt;(hw, hw-&amp;gt;wlFE)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//no gckASYNC_FE_Initialize(hw, hw-&amp;gt;asyncFE)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//no regPMC&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//no AHBDEC400&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//no AXI_FE&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&lt;b&gt;gckHARDWARE_SetMMU&lt;/b&gt;(hw, hw-&amp;gt;kernel-&amp;gt;mmu)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//maxOutstandingReads == 0&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if(gcvFEATURE_NEW_GPIPE &amp;amp;&amp;amp; !gcvFEATURE_GPIPE_CLOCK_GATE_FIX) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; if (regPMC==0)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckOS_ReadRegisterEx(hw-&amp;gt;powerBaseAddress + GC_MODULE_POWER_MODULE_CONTROL_Address)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; regPMC |= GC_MODULE_POWER_MODULE_CONTROL DISABLE_MODULE_CLOCK_GATING_GPIPE 1&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//Disable RA HZ clock gating&lt;/div&gt;&lt;div&gt;regPMC |= GC_MODULE_POWER_MODULE_CONTROL DISABLE_MODULE_CLOCK_GATING_RA_HZ 1&lt;/div&gt;&lt;div&gt;//Disable RA EZ clock gating&lt;/div&gt;&lt;div&gt;regPMC |= GC_MODULE_POWER_MODULE_CONTROL DISABLE_MODULE_CLOCK_GATING_RA_EZ 1&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//中间还有很多硬件型号对比去做power clock 相关的设置&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(hw-&amp;gt;powerBaseAddress + GC_MODULE_POWER_MODULE_CONTROL_Address, regPMC)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if(hw-&amp;gt;identity.chipRevision&amp;gt;0x5420 &amp;amp;&amp;amp; gcvFEATURE_PIP_3D) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; //Disable internal DFS&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; data = GC_PULSE_EATER ENABLE_AUTO_PULSE_SH 0&lt;br&gt;&amp;nbsp; &amp;nbsp; data |= GC_PULSE_EATER DISABLE_AUTO_PULSE 1&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;gckOS_WriteRegisterEx(GC_PULSE_EATER_Address, data)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if(gcvFEATURE_NN_ENGINE &amp;amp;&amp;amp; (!gcvFEATURE_HI_REORDER_FIX || hw-&amp;gt;kernel-&amp;gt;device-&amp;gt;extSRAMSize[0]=0) &amp;amp;&amp;amp;&lt;br&gt;&amp;nbsp; hw-&amp;gt;featureDatabase-&amp;gt;HI_DEFAULT_ENABLE_REORDER_FIX) {&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; data = GCREG_CONTROL2 DISABLE_AXI_READ_REORDER 1&lt;br&gt;&amp;nbsp; &amp;nbsp; gckOS_WriteRegisterEx(GCREG_CONTROL2_Address, data)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//配置AXI policy&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;_ConfigurePolicyID&lt;/b&gt;(hw)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//通过command 控制NN&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckHARDWARE_PowerControlClusters&lt;/b&gt;(hw, hw-&amp;gt;options.configNNPowerControl, true)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckOS_WriteRegisterEx(AQ_INTR_ENBL_Address, 0xFFFFFFFF)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-56" vertex="1">
          <mxGeometry y="60" width="670" height="1160" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-60" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-40" target="XHSnjxVOCnQZ8cdE8w61-56" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-780" y="-4693" as="sourcePoint" />
            <mxPoint x="-350" y="-4640" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-61" value="gc_hal_kernel_hardware.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="510" y="-4580" width="430" height="114" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-62" value="&lt;b&gt;gckHARDWARE_SetMMU(hw, gckMMU mmu)&lt;/b&gt;&lt;div&gt;&lt;b&gt;设置页表baseAddress&lt;/b&gt;&lt;/div&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-61" vertex="1">
          <mxGeometry y="26" width="430" height="54" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-63" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-61" vertex="1">
          <mxGeometry y="80" width="430" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-64" value="+ method(type): type" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-61" vertex="1">
          <mxGeometry y="88" width="430" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-65" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1.002;exitY=0.446;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-59" target="XHSnjxVOCnQZ8cdE8w61-61" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="550" y="-4380" as="sourcePoint" />
            <mxPoint x="980" y="-4033" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-67" value="gc_hal_kernel_hardware.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-280" y="-3800" width="300" height="120" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-68" value="&lt;span style=&quot;font-weight: 700; text-align: center;&quot;&gt;gckCOMMAND_Start(gckCOMMAND Command)&lt;/span&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-67" vertex="1">
          <mxGeometry y="26" width="300" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-69" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-67" vertex="1">
          <mxGeometry y="52" width="300" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-70" value="if (Command-&amp;gt;feType == gcvHW_FE_WAIT_LINK)&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;_StartWaitLinkFE&lt;/b&gt;(Command)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-67" vertex="1">
          <mxGeometry y="60" width="300" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-71" value="gc_hal_kernel_hardware.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="120" y="-3710" width="740" height="530" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-72" value="&lt;b&gt;_StartWaitLinkFE(gckCOMMAND Command)&lt;/b&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-71" vertex="1">
          <mxGeometry y="26" width="740" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-73" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-71" vertex="1">
          <mxGeometry y="52" width="740" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-74" value="hardware = Command-&amp;gt;kernel-&amp;gt;hardware&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//查询 WAIT/LINK 序列的大小&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_WaitLink&lt;/b&gt;(hw, NULL, INVALID_ADDRESS, Command-&amp;gt;offset, &amp;amp;waitLinkBytes, NULL,NULL)&amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;// waitLinkBytes =32&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//此处 Command-&amp;gt;logical == NULL&lt;/span&gt;&lt;/div&gt;&lt;div&gt;if (Command-&amp;gt;pageSize - Command-&amp;gt;offset &amp;lt; waitLinkBytes) || Command-&amp;gt;logical == NULL) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//创建一个新的Command queue&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;_NewQueue&lt;/b&gt;(Command, true)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;logical = Command-&amp;gt;logical + Command-&amp;gt;offset&lt;/div&gt;&lt;div&gt;address = Command-&amp;gt;address + Command-&amp;gt;offset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-71" vertex="1">
          <mxGeometry y="60" width="740" height="210" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-92" value="&lt;div&gt;&lt;b&gt;gckWLFE_WaitLink&lt;/b&gt;(hw, logical, address, 0, &amp;amp;waitLinkBytes, &amp;amp;waitOffset, &amp;amp;Command-&amp;gt;waitPos.size)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-71" vertex="1">
          <mxGeometry y="270" width="740" height="26" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-95" value="&lt;span style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;//更新 wait command 地址&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;Command-&amp;gt;waitPos.videoMem = Command-&amp;gt;videoMem&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;Command-&amp;gt;waitPos.offset = Command-&amp;gt;offset + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;Command-&amp;gt;waitPos.logical = logical + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckVIDMEM_NODE_CleanCache&lt;/b&gt;(..., Command-&amp;gt;offset, logical, waitLinkBytes)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-71" vertex="1">
          <mxGeometry y="296" width="740" height="104" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-102" value="&lt;span style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;//调整 offset&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;Command-&amp;gt;offset += waitLinkBytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;Command-&amp;gt;newQueue = false&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-71" vertex="1">
          <mxGeometry y="400" width="740" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-103" value="&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;b&gt;gckWLFE_Execute&lt;/b&gt;(hw, address, waitLinkBytes)&lt;br&gt;&lt;/span&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;// Command queue 已经运行&lt;/span&gt;&lt;/div&gt;&lt;div&gt;Command-&amp;gt;running = true&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-71" vertex="1">
          <mxGeometry y="460" width="740" height="70" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-75" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-55" target="XHSnjxVOCnQZ8cdE8w61-67" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-780" y="-4657" as="sourcePoint" />
            <mxPoint x="-270" y="-5150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-76" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-70" target="XHSnjxVOCnQZ8cdE8w61-71" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-570" y="-3880" as="sourcePoint" />
            <mxPoint x="60" y="-3360" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-77" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1000" y="-4100" width="690" height="470" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-78" value="&lt;b&gt;_NewQueue(gckCOMMAND Command, gctBOOL Stall)&lt;br&gt;Stalled, 硬件是否已经Stall&lt;/b&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-77" vertex="1">
          <mxGeometry y="26" width="690" height="54" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-79" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-77" vertex="1">
          <mxGeometry y="80" width="690" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-80" value="&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//切换到下一个command buffer&lt;/span&gt;&lt;/div&gt;currentIndex = Command-&amp;gt;index&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; // currentIndex = -1&lt;div&gt;newIndex = (currentIndex + 1) % gcdCOMMAND_QUEUES&amp;nbsp; &amp;nbsp;// newIndex = 0&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//等待新的QUEUE 可用&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckOS_WaitSignal&lt;/b&gt;(Command-&amp;gt;os, Command-&amp;gt;queues[newIndex].signal, false, kernel-&amp;gt;timeOut)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//用新的 command queue 更新 gckCOMMAND&lt;/div&gt;&lt;div&gt;Command-&amp;gt;index = newIndex&lt;/div&gt;&lt;div&gt;Command-&amp;gt;newQueue = true&lt;/div&gt;&lt;div&gt;Command-&amp;gt;videoMem = Command-&amp;gt;queues[newIndex].videoMem&lt;/div&gt;&lt;div&gt;Command-&amp;gt;logical = Command-&amp;gt;queues[newIndex].logical&lt;/div&gt;&lt;div&gt;Command-&amp;gt;address = Command-&amp;gt;queues[newIndex].&lt;span style=&quot;background-color: initial;&quot;&gt;address&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;Command-&amp;gt;pool = Command-&amp;gt;queues[newIndex].pool&lt;/div&gt;&lt;div&gt;Command-&amp;gt;offset = 0&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (currentIndex != -1) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp;if (Stalled) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_Signal(Command-&amp;gt;os, Command-&amp;gt;queues[currentIndex].signal, true)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp;} else {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckEVENT_Signal(Command-&amp;gt;kernel-&amp;gt;eventObj, Command-&amp;gt;queues[currentIndex].signal, gcvKERNEL_COMMAND)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-77" vertex="1">
          <mxGeometry y="88" width="690" height="382" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-81" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" parent="1" target="XHSnjxVOCnQZ8cdE8w61-77" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="860" y="-3570" as="sourcePoint" />
            <mxPoint x="1060" y="-3740.91" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-84" value="" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="1045" y="-3450" width="775" height="80" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-85" value="offset&amp;nbsp;&lt;br&gt;0" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="1000" y="-3450" width="80" height="80" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-86" value="Wait" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="1080" y="-3450" width="90" height="80" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-87" value="Link" style="rounded=0;whiteSpace=wrap;html=1;strokeWidth=3;" parent="1" vertex="1">
          <mxGeometry x="1170" y="-3450" width="90" height="80" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-96" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-92" target="XHSnjxVOCnQZ8cdE8w61-85" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-70" y="-3490" as="sourcePoint" />
            <mxPoint x="30" y="-3490" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-97" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;strokeWidth=5;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1215" y="-3450" as="sourcePoint" />
            <mxPoint x="1080" y="-3450" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1215" y="-3500" />
              <mxPoint x="1080" y="-3500" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-98" value="gc_hal_kernel_hardware_waitlink_fe.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1000" y="-3200" width="650" height="450" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-99" value="&lt;b&gt;gckWLFE_Execute(Hardware, gctADDRESS Address, gctUINT32 Bytes)&lt;/b&gt;&lt;div&gt;用初始cmd, 让硬件的cmd processor开始运行&lt;/div&gt;" style="text;strokeColor=#36393d;fillColor=#eeeeee;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-98" vertex="1">
          <mxGeometry y="26" width="650" height="44" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-100" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="XHSnjxVOCnQZ8cdE8w61-98" vertex="1">
          <mxGeometry y="70" width="650" height="8" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-101" value="&lt;div&gt;eventEnable = 0xFFFFFFFF&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//使能所有的event&lt;/span&gt;&lt;div&gt;&lt;b&gt;gckOS_WriteRegisterEx&lt;/b&gt;(AQ_INTR_ENBL_Address, eventEnable)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//graphicsLargeVA&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckOS_WriteRegisterEx&lt;/b&gt;(AQ_CMD_BUFFER_ADDR_HI_Address, Address&amp;gt;&amp;gt;32)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;gckOS_WriteRegisterEx&lt;/b&gt;(AQ_CMD_BUFFER_ADDR_Address, address)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//设置 control register&lt;/span&gt;&lt;/div&gt;&lt;div&gt;control = (AQ_CMD_BUFFER_CTRL ENABLE) | (AQ_CMD_BUFFER_CTRL PREFETCH (Bytes+7)&amp;gt;&amp;gt;3&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//保证 写command buffer 和 AHB reg 已经完成&lt;/div&gt;&lt;div&gt;&lt;b style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;gckOS_MemoryBarrier&lt;/b&gt;(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;switch(hw-&amp;gt;options.secureMode)&lt;/div&gt;&lt;div&gt;case gcvSECURE_NODE: ...;&lt;/div&gt;&lt;div&gt;case gcvSECURE_IN_NORMAL:&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;b&gt;gckOS_WriteRegisterEx&lt;/b&gt;(GCREG_CMD_BUFFER_AHB_CTRL_Address, control)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//递增 executionCount&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;hw-&amp;gt;executionCount++&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//2&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//记录最近的execution address&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;hw-&amp;gt;lastExecutionAddress = Address&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="XHSnjxVOCnQZ8cdE8w61-98" vertex="1">
          <mxGeometry y="78" width="650" height="372" as="geometry" />
        </mxCell>
        <mxCell id="XHSnjxVOCnQZ8cdE8w61-105" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" parent="1" source="XHSnjxVOCnQZ8cdE8w61-103" target="XHSnjxVOCnQZ8cdE8w61-98" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="870" y="-3417" as="sourcePoint" />
            <mxPoint x="1010" y="-3440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="RsXz8Ytodcc2n_-1sCKY-1" value="" style="endArrow=classic;html=1;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="XHSnjxVOCnQZ8cdE8w61-102" target="XHSnjxVOCnQZ8cdE8w61-87">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="960" y="-3260" as="sourcePoint" />
            <mxPoint x="1010" y="-3310" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1260" y="-3280" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="RsXz8Ytodcc2n_-1sCKY-2" value="Command.offset" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="RsXz8Ytodcc2n_-1sCKY-1">
          <mxGeometry x="-0.2061" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="RsXz8Ytodcc2n_-1sCKY-3" value="" style="endArrow=classic;html=1;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="XHSnjxVOCnQZ8cdE8w61-95" target="XHSnjxVOCnQZ8cdE8w61-86">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="870" y="-3270" as="sourcePoint" />
            <mxPoint x="1270" y="-3360" as="targetPoint" />
            <Array as="points">
              <mxPoint x="910" y="-3360" />
              <mxPoint x="910" y="-3330" />
              <mxPoint x="1080" y="-3330" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="RsXz8Ytodcc2n_-1sCKY-4" value="Command.waitPos.logical" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="RsXz8Ytodcc2n_-1sCKY-3">
          <mxGeometry x="-0.2061" y="-1" relative="1" as="geometry">
            <mxPoint x="35" as="offset" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
