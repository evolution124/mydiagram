<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0" version="25.0.3">
  <diagram name="Page-1" id="9GhINJhexpfvpIPdTT9F">
    <mxGraphModel dx="3126" dy="1982" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="qWvV4iFXAZPfeYybYjg1-1" value="&lt;div&gt;&lt;span style=&quot;&quot;&gt;gc_hal_kernel.cpp&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; gckDEVICE_Dispatch(Device, Interface)&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; gckOS_GetProcessID(&amp;amp;processID)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; case gcvHAL_COMMIT;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;_Commit(Device, Kernel-&amp;gt;hardware-&amp;gt;type, Interface-&amp;gt;engine, processID, Interface-&amp;gt;u.Commit.broCoreMask, &amp;amp;Interface-&amp;gt;u.Commit)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt;_Commit(Device, HwType, Engine, ProcessId, BroCoreMask, Commit);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;subCommit = Commit&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;kernel = Device-&amp;gt;coreInfoArray[subCommit-&amp;gt;coreId].kernel&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;command = kernel-&amp;gt;command&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;eventObj = kernel-&amp;gt;eventObj&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckCOMMAND_Commit(command, subCommit, ProcessId, Commit-&amp;gt;shared, &amp;amp;Commit-&amp;gt;commitStamp, &amp;amp;Commit-&amp;gt;contextSwitched)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckEVENT_Commit(eventObj, subCommit-&amp;gt;queue, gcvFALSE, command-&amp;gt;feType!=gcvHW_FE_END, Commit-&amp;gt;shared)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; gckEVENT_Submit(Event, &amp;amp;eventAttr)&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="2880" y="40" width="800" height="440" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="qWvV4iFXAZPfeYybYjg1-3" target="qWvV4iFXAZPfeYybYjg1-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="qWvV4iFXAZPfeYybYjg1-3" target="qWvV4iFXAZPfeYybYjg1-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="5720" y="1040" />
              <mxPoint x="5720" y="1010" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-3" value="gc_hal_kernel_command.c&lt;br&gt;&lt;br&gt;gckCOMMAND_Commit(Command, *SubCommit, ProcessId, Shared, CommitStamp, contextSwitched)&lt;br&gt;&amp;nbsp; &amp;nbsp; cmdLoc = &amp;amp;SubCommit-&amp;gt;commandBuffer;&lt;br&gt;&amp;nbsp; &amp;nbsp; delta =&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; if (SubCommit-&amp;gt;context)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;//通过kernel-&amp;gt;db-&amp;gt;pointerDatabase-&amp;gt;table[(UINT32_T)SubCommit-&amp;gt;context -1] 获取&lt;/font&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;context = gckKERNEL_QueryPointerFromName(Command-&amp;gt;kernel, SubCommit-&amp;gt;context)&lt;/span&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckKERNEL_GetCurrentMMU(Command-&amp;gt;kernel, gcvTRUE, 0, &amp;amp;mmu) &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;???&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//如果context不同, 切换MMU 页表&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;Command-&amp;gt;kernel-&amp;gt;processPageTable&lt;/span&gt; &amp;amp;&amp;amp; &lt;span style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;Command-&amp;gt;currContext!= context&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckKERNEL_SwitchMMU(Command-&amp;gt;kernel, Shared, mmu)&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//获取power/Command 锁, 递增Command-&amp;gt;atomCommit&lt;/font&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; gckCOMMAND_EnterCommit(Command, gcvFALSE);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; _HandlePatchList(...)&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;feType == gcvHW_FE_WAIT_LINK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;_CommitWaitLinkOnce(Command, context, cmdLoc, delta, ProcessId, Shared, contextSwitched, NULL, FALSE, ...)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; commandBufferLogical = CommandBuffer-&amp;gt;logical + CommandBuffer-&amp;gt;startOffset;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferAddress = CommandBuffer-&amp;gt;address + CommandBuffer-&amp;gt;startOffset;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferSize = CommandBuffer-&amp;gt;size;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckCOMMAND_CheckFlushMMU(Command, hardware)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; &lt;font color=&quot;#ff3333&quot;&gt;//如果页表有更新, flush mmu, 通过插入command flsuh mmu&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckHARDWARE_FlushMMU(Hardware, gcvNULL, gcvINVALID_ADDRESS, 0, &amp;amp;flushBytes);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//pointer 为command buffer的logical-offset, size 为page_size-offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckCOMMAND_Reserve(Command, flushBytes, &amp;amp;pointer, &amp;amp;bufferSize)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; if(Command-&amp;gt;feType == gcvHW_FE_WAIT_LINK)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;//为之后挂接到command buffer 的WAIT/LINK 预留空间&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckWLFE_WaitLink(hardware, gcvNULL, gcvINVALID_ADDRESS, Command-&amp;gt;offset + requestedAligned, &amp;amp;requiredBytes, gcvNULL, gcvNULL)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;//添加flush MMU的loadstate 和 command ??? (是否是预留的 command head ???&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckHARDWARE_FlushMMU(Hardware, pointer, address, (bufferSize - flushBytes), &amp;amp;flushBytes)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (Command-&amp;gt;feType == gcvHW_FE_WAIT_LINK)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;gckCOMMAND_Execute(Command, flushBytes)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkLogical = Command-&amp;gt;logical + offset;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkAddress = Command-&amp;gt;address + offset;&lt;/div&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if (Context == NULL) {&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;else if (Command-&amp;gt;cuurContext != Context) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;contextBuffer = Context-&amp;gt;buffer;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;gckCONTEXT_Update(Context, ProcessID, StateDelta);&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if(CommandBuffer-&amp;gt;entryPipe == gcvPIPE_3D) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;offset = CommandBufer-&amp;gt;reservedHead;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;b style=&quot;background-color: rgb(0, 204, 0);&quot;&gt;//把contextBuffer-&amp;gt;link3D的位置添加上Link 到 commandBuffer的末尾&lt;/b&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckWLFE_Link(hw, contextBuffer-&amp;gt;link3D, commandBufferAddress + offset, commandBufferSize - offset, &amp;amp;linkBytes, &amp;amp;commandLinkLow, &amp;amp;commandLinkHigh)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckVIDMEM_NODE_CleanCache(Command-&amp;gt;kernel, contextBuffer-&amp;gt;videoMem, entryAddress - contextBuffer-&amp;gt;address, entryLogical,&amp;nbsp;&lt;/div&gt;&lt;div&gt;entryBytes)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Command-&amp;gt;currContext = Context;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;*contextSwitched = gcvTRUE;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exitAddress = waitLinkAddress;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exitBytes = waitLinkBytes;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//在command buffer的头上加入 WAIT/LINK, 暂时LOOP&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckWLFE_WaitLink(hw, waitLinkLogical, waitLinkAddress, offset, &amp;amp;waitLinkBytes, &amp;amp;waitOffset, &amp;amp;waitSize);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(..., Command-&amp;gt;offset, waitLinkLogical, exitBytes)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; commandBufferTail = commandBufferLogical + commandBufferSize - CommandBuffer-&amp;gt;reservedTail&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//在commandbuffer的末尾添加fence&lt;/font&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckHARDWARE_Fence(hw, gcvENGINE_RENDER, commandBufferTail, Command-&amp;gt;fence-&amp;gt;address, Command-&amp;gt;commitStamp, &amp;amp;fencebytes)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; commandBufferTail += fencebytes&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (Shared == gcvFALSE)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//在commandbuffer的末尾添加Link, link到 exitLinkLow(其实是之前添加的 WAIT/LINK command)&lt;/font&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckWLFE_Link(hw, commandBufferTail, exitAddress, exitBytes, &amp;amp;linkBytes, &amp;amp;exitLinkLow, &amp;amp;exitLinkHigh)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckVIDMEM_HNDLE_Lookup(Command-&amp;gt;kernel, ProcessID, CommandBuffer-&amp;gt;videoMemNode, &amp;amp;commandBufferVideoMem)l&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(...)&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;// Link到entryAddress (如果有context, 就是对应context-buffer), 开始执行????&lt;/font&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckWLFE_Link(hw, Command-&amp;gt;waitPos.logical, entryAddress, entryBytes, &amp;amp;Command-&amp;gt;waitPos.Size, &amp;amp;entryLinkLow, &amp;amp;entryLinkHight)&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(.... ) //Command-&amp;gt;waitPos相关&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//更新Command&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Command-&amp;gt;pipeSelect = CommandBuffer-&amp;gt;exitPipe;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Command-&amp;gt;offset+= waitLinkBytes&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.offset = Command-&amp;gt;offset - waitLinkBytes + waitOffset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.logical = waitLinkLogical + waitOffset&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPost.address = waitLinkAddress + waitOffset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckHARDWARE_UpdateQueueTail(hw, Command-&amp;gt;logical, Command-&amp;gt;offset)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;arcSize=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="4340" y="110" width="1230" height="1480" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;entryX=0.002;entryY=0.453;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="qWvV4iFXAZPfeYybYjg1-1" target="qWvV4iFXAZPfeYybYjg1-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-5" value="gc_hal_kernel_hardware.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckCONTEXT_Update(Context, ProcessID, StateDelta)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; buffer = Context-&amp;gt;buffer&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="5775" y="80" width="450" height="300" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-6" value="gc_hal_kernel_hardware_waitlink_fe.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_Link(hardware, Logical, FetchAddress, FetchSize, Bytes, Low, High)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; address = FetchAddress&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //CommandBuffer 算是offset的Device地址&lt;br&gt;&amp;nbsp; &amp;nbsp; High = FetchAddress&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bytes = align(FetchAddress + FetchSize, 64) - FetchAddress //CommandBuffer 有效的大小&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Hardware-&amp;gt;graphicsLargeVA) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 1, 0)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// OPCODE先清零(配置好 cmd再设置 OPCODE&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 2，address)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 低32位&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 3 , FetchAddress &amp;gt;&amp;gt; 32);&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 高32位&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;link = ... //设置link为 LINK64 并且PREFETCH大小为bytes&amp;gt;&amp;gt;3 &lt;font color=&quot;#ff3333&quot;&gt;// 配置link的 opcode&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckOS_WriteMemory(os, logical, link)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 设置CMD的 OPCODE, Prefetch&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;Low = link&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="5775" y="480" width="720" height="290" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-8" value="gc_hal_kernel_hardware_waitlink_fe.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_WaitLink(hardware, Logical, Address, Offset, Bytes, WaitOffset, WaitSize)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; hw-&amp;gt;lastWaitLink = Address //保存 WAIT/LINK的地址&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; opLogical = Logical;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//设置WAIT命令&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical++ = ... // WAIT64 与 hw-&amp;gt;waitCount;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; opLogical++&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//设置LINK命令, 当前LINK到 WAIT命令, 形成LOOP&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical++ = ...// LINK64 与 PREFETCH&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical = Address;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WaitOffset = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WaitSize = waitSize;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Bytes = bytes;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="5785" y="880" width="720" height="260" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-10" value="gc_hal_kernel_hardware.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckHARDWARE_Fence(hardware, Engine, Logical, FenceAddress, FenceData, Bytes)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; if (Engine == gcvENGINE_RENDER)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; _FenceRender(hw, Logical, FenceAddress, FenceData, Bytes)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; dataLow = FenceData&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dataHigh = FenceData &amp;gt;&amp;gt; 32&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (logical) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE....)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E75 gcregFenceAddressHiRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, FenceAddress &amp;gt;&amp;gt; 32); //设置Fence State 地址高32bit&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...) //设置 E1A gcregFenceAddressRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, fenceAddress)&amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 fence低32位&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E26 gcregFenceDataHighRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, dataHigh)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E1B gcregFenceDataRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, dataLow)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Bytes = gcdRENDER_FENCE_LENGTH+8&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="5785" y="1240" width="720" height="360" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="qWvV4iFXAZPfeYybYjg1-3" target="qWvV4iFXAZPfeYybYjg1-10" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="5580" y="1050" as="sourcePoint" />
            <mxPoint x="5795" y="1020" as="targetPoint" />
            <Array as="points">
              <mxPoint x="5570" y="1360" />
              <mxPoint x="5785" y="1360" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-12" value="&lt;div&gt;gc_hal_kernel_kernel.cpp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckKERNEL_Notify(kernel, Notification)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; switch(Notification) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; case gcvNOTIFY_INTERRUPT:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckHARDWARE_Notify(kernel-&amp;gt;hardware)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; gckEVENT_Notify(Hardware-&amp;gt;kernel-&amp;gt;eventObj, 0, &amp;amp;fault);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; for (;;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckOS_AtomGet(Event-&amp;gt;os, Event-&amp;gt;pending, &amp;amp;pending);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if( pending &amp;amp; (1&amp;lt;&amp;lt;29) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//event29 是 invalidation pipe的特殊EVENT&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if( pending &amp;amp; 0x80000000) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//AXI bus error&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if (pending &amp;amp; 0x40000000) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// MMU exception&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckFENCE_Signal(os, Event-&amp;gt;kernel-&amp;gt;command-&amp;gt;fence)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="6570" y="250" width="450" height="400" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="qWvV4iFXAZPfeYybYjg1-13" target="qWvV4iFXAZPfeYybYjg1-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-13" value="&lt;div&gt;gc_hal_kernel_emulator.cpp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;InterruptThread(void *)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;while(wrapper-&amp;gt;interruptSuspended)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;gckHARDWARE_Interrupt(kernel-&amp;gt;hardware)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;gckKERNEL_Notify(kernel, gcvNOTIFY_INTERRUPT)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="6570" y="30" width="450" height="160" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-1" value="&lt;span style=&quot;text-align: left;&quot;&gt;drv_api.cpp&lt;/span&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-920" y="-400" width="630" height="606" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-2" value="&lt;div&gt;&lt;b&gt;drvLaunchKernelEx_common(config, f, kernelParams, extra, ptsz):&lt;br&gt;&lt;/b&gt;&amp;nbsp; &amp;nbsp; kernelParams: 就是user传入的args,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; extra: ???&amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; ptsz: 是否是perThread Stream&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-1">
          <mxGeometry y="26" width="630" height="74" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-3" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//获取CUcontext&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;div&gt;ctx = getCurrentContext()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;//获取gridDimX/Y/Z, blockDimX/Y/Z, sharedMemBytes等配置信息&lt;br&gt;&lt;/span&gt;gridDimX = config-&amp;gt;gridDimX&lt;br&gt;...&lt;br&gt;sharedMemBytes = config-&amp;gt;sharedMemBytes&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//获取CUStream&lt;/span&gt;&lt;/div&gt;&lt;div&gt;hStream = getCurrentStream(ctx, stream, perThread)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//根据 f-&amp;gt;kernelInfo-&amp;gt;argCount 创建kernelArgData_t&lt;/span&gt;&lt;/div&gt;&lt;div&gt;kernelArgData_t* argData = malloc(sizeof(kernelArgData_t)*argCount)&lt;/div&gt;&lt;div&gt;for (;;) {&lt;br&gt;&amp;nbsp; &amp;nbsp; kernelArgData_t data = argData + i;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; kernelArg_t arg = &lt;font color=&quot;#ff3333&quot;&gt;f-&amp;gt;kernelInfo&lt;/font&gt;-&amp;gt;args + i;&lt;br&gt;&amp;nbsp; &amp;nbsp; data-&amp;gt;arg = arg&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ... //&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//准备 halQueue_t 与 halCommand_t&lt;/span&gt;&lt;br&gt;halQueue = getCurrentStream(ctx, hStream, false)-&amp;gt;halQueue &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//此时 hStream是有效指针, 基本是直接返回&lt;/span&gt;&lt;br&gt;command = {&lt;font color=&quot;#ff3333&quot;&gt;COMMAND_KERNEL&lt;/font&gt;} &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//设置command 为KERNEL(type 有COPY, WAIT, FENCE 等)&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#ff3333&quot;&gt;executeKrnelInfo_t&lt;/font&gt; *info = command.kernelInfo&lt;br&gt;info-&amp;gt;local[0] = blockDimX...; info-&amp;gt;gridDim[0] = gridDimX ...; info-&amp;gt;global[0]= gridDimX*info-&amp;gt;local[0] ...&lt;br&gt;info-&amp;gt;args = argData;&lt;/div&gt;&lt;div&gt;info-&amp;gt;kInfo= f-&amp;gt;kernelInfo;&lt;br&gt;info-&amp;gt;inst = f-&amp;gt;kernel&lt;/div&gt;&lt;div&gt;prepareExecInfo(info)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//调用&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#ff3333&quot;&gt;&lt;b&gt;launchCommand(halQueue, &amp;amp;command)&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-1">
          <mxGeometry y="100" width="630" height="480" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-32" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-1">
          <mxGeometry y="580" width="630" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-5" value="Color Chart" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="770" y="-650" width="160" height="138" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-7" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-5">
          <mxGeometry y="26" width="160" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-6" value="Context" style="text;strokeColor=#6c8ebf;fillColor=#dae8fc;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-5">
          <mxGeometry y="34" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-8" value="Command" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-5">
          <mxGeometry y="60" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-16" value="Comment" style="text;strokeColor=#82b366;fillColor=#FFFFCC;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-5">
          <mxGeometry y="86" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-17" value="???" style="text;strokeColor=#82b366;fillColor=#FFE599;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-5">
          <mxGeometry y="112" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-9" value="&lt;span style=&quot;text-align: left;&quot;&gt;stream.cpp&lt;/span&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-170" y="-200" width="490" height="220" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-10" value="&lt;div&gt;&lt;b&gt;getCurrentStream(CUcontext ctx, CUStream stream, bool perThread):&lt;br&gt;&lt;/b&gt;&amp;nbsp; &amp;nbsp; stream 用户传入的stream&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-9">
          <mxGeometry y="26" width="490" height="44" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-11" value="&lt;div&gt;istream = (size_t)stream;&lt;/div&gt;switch(istream)&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;case 0: return getDefaultStream(ctx, perThread)&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; 如果perThread --&amp;gt; getPerThreadStream(ctx)&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;否则 --&amp;gt;getLegacyStream(ctx) --&amp;gt; ctx-&amp;gt;legacy &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;(如何创建???)&lt;/span&gt;&lt;br&gt;case 1: return getLegacyStream(ctx)&lt;br&gt;case 2: return getPerThreadStream(ct)&lt;br&gt;default:&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;... &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//和delayDestroy 相关 ???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-9">
          <mxGeometry y="70" width="490" height="150" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-19" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;drv_api.cpp&lt;/span&gt;&lt;/div&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-170" y="-390" width="490" height="140" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-20" value="&lt;div&gt;&lt;b&gt;getCurrentContext():&lt;/b&gt;&amp;nbsp;获取当前的context&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-19">
          <mxGeometry y="26" width="490" height="24" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-21" value="&lt;div&gt;tssData_PTR tss = getTssData(); &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取线程本地数据&lt;/span&gt;&lt;br&gt;&lt;br&gt;ctx = utilStackTop(tss-&amp;gt;ctxStack); &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取最近创建的CUcontext&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return gpgpuPLS.drvDevices[tss-&amp;gt;runtimeDeviceId]-&amp;gt;primaryCtx &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//如何创建???&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-19">
          <mxGeometry y="50" width="490" height="90" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-25" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-800" y="280" width="390" height="176" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-26" value="&lt;b&gt;launchCommand(halQueue_PTR queue, halCommand_t * cmd)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-25">
          <mxGeometry y="26" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-27" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-25">
          <mxGeometry y="52" width="390" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-28" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//根据type调用相应的函数&lt;br&gt;&lt;/span&gt;switch(cmd-&amp;gt;type)&lt;br&gt;case &lt;font color=&quot;#ff3333&quot;&gt;COMMAND_KERNEL&lt;/font&gt;: &lt;b&gt;executeKernel(queue, cmd)&lt;/b&gt;&lt;br&gt;...&lt;br&gt;case&amp;nbsp;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-25">
          <mxGeometry y="60" width="390" height="90" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-34" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-25">
          <mxGeometry y="150" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-33" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.501;exitY=1.038;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-32" target="QSAenKkpdjQW8zQk9t1L-25">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-900" y="250" as="sourcePoint" />
            <mxPoint x="-820" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-35" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-882" y="560" width="550" height="320" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-36" value="&lt;b&gt;executeKernel(halQueue_PTR queue, halCommand* halCmd)&lt;/b&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-35">
          <mxGeometry y="26" width="550" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-37" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-35">
          <mxGeometry y="52" width="550" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-38" value="executeKernelInfo_t * execInfo = &amp;amp;halCmd-&amp;gt;kernelInfo&lt;br&gt;&lt;br&gt;execInfo-&amp;gt;halQueue = queue&lt;br&gt;cmdBuffer_PTR &lt;font color=&quot;#ff3333&quot;&gt;cmdBuffer &lt;/font&gt;= &lt;b&gt;createCommandBuffer&lt;/b&gt;(processor, 1024, 1024)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;clfBeginVIRUniform(&lt;font color=&quot;#ff3333&quot;&gt;cmdBuffer&lt;/font&gt;, execInfo-&amp;gt;inst, null)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; //添加硬件配置cmd, 并且写入 semaphoreStall 与 Stall 命令&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;__clCmdLoadSingalHWState(states, AQSemaphoreRegAddrs, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;__clCmdLoadingFECommand(states, STALL, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;allocInternalMemory(execInfo)&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;clfEndVIRUniform(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;clfInvokeVIRKernel&lt;/b&gt;(cmdBuffer, execInfo-&amp;gt;inst, execInfo-&amp;gt;workDim, ...., &amp;amp;invokeInfo)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//把cmdBuffer挂载到queue的commandQueue上&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;addCmdToQueue&lt;/b&gt;(queue, cmdBuffer)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-35">
          <mxGeometry y="60" width="550" height="260" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-39" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.51;entryY=0.005;entryDx=0;entryDy=0;exitX=0.508;exitY=1.035;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-34" target="QSAenKkpdjQW8zQk9t1L-35">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-594" y="217" as="sourcePoint" />
            <mxPoint x="-595" y="290" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-41" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-170" y="320" width="460" height="300" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-42" value="&lt;b&gt;createCommandBuffer(processor, size)&lt;/b&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-41">
          <mxGeometry y="26" width="460" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-43" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-41">
          <mxGeometry y="52" width="460" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-44" value="cmd = malloc(sizeof(cmdBuffer_t))&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//通过cmd-Buffer - cmdBase 可以计算cmd的个数&lt;br&gt;&lt;/span&gt;cmd-&amp;gt;cmdBase = malloc(size)&lt;br&gt;cmd-&amp;gt;cmdBuffer = cmd-&amp;gt;cmdBase&lt;br&gt;cmd-&amp;gt;processor = processor&lt;br&gt;cmd-&amp;gt;helper.index = gCmdIdx++;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//向cmdBuffer中添加init cmds&lt;/span&gt;&lt;/div&gt;&lt;div&gt;clfInitCommandQueue(cmd)&lt;br&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//通过&amp;nbsp;__clCmdLoadSingleHWState 往cmdBuffer添加LoadState 配置&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;28A AQSystemRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E13 AQModeRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;5580 gcregShaderMiscConfigRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E44 gcregClusterControlRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E80 gcregMultiChipControlRegAddrs&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-41">
          <mxGeometry y="60" width="460" height="240" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-45" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=-0.005;entryY=0.053;entryDx=0;entryDy=0;exitX=1.006;exitY=0.166;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-41">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-592" y="487" as="sourcePoint" />
            <mxPoint x="-589" y="561" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-46" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.003;entryY=0.111;entryDx=0;entryDy=0;exitX=1.002;exitY=0.298;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-3" target="QSAenKkpdjQW8zQk9t1L-19">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-280" y="-14" as="sourcePoint" />
            <mxPoint x="-163" y="-230" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-47" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.001;entryY=0.083;entryDx=0;entryDy=0;exitX=0.997;exitY=0.594;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-3" target="QSAenKkpdjQW8zQk9t1L-9">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-279" y="-147" as="sourcePoint" />
            <mxPoint x="-119" y="-324" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-48" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-170" y="650" width="530" height="560" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-49" value="&lt;b&gt;clfInvokeVIRKernel(cmdBuffer_PTR cmdBuffer, KernelInst_PTR kernelInst,...)&lt;br&gt;通过将要运行的kernel, 配置cmd buffer&lt;/b&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-48">
          <mxGeometry y="26" width="530" height="44" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-50" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-48">
          <mxGeometry y="70" width="530" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-51" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;compilerCmd = *states; //states 就是cmdBuffer-&amp;gt;cmdBuffer&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;compilerCmdCount = hwStates-&amp;gt;stateBufferSize/sizeof(uint32_t)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //22&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;memcpy(*states, hwStates-&amp;gt;pStateBuffer, hwStates-&amp;gt;stateBufferSize)&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;*states += compilerCmdCount;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//配置指令地址 0x040A&lt;/span&gt;&lt;div&gt;physical = getDeviceAddr(kernelInst-&amp;gt;instMem, kernelInst-&amp;gt;processor)&lt;br&gt;__clCmdLoadSingleHWState(states, gcregPSInstructionRegAddrs, physical)&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//NN相关&lt;/span&gt;&lt;/div&gt;&lt;div&gt;clfTCBasicConfig(cmdBuffer, kernelInst)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//Load State 配置&lt;/div&gt;&lt;div&gt;AQPixelShaderInputControlRegAddrs&amp;nbsp;&lt;br&gt;AQPixelShaderTemporaryRegisterControlRegAddrs&lt;/div&gt;&lt;div&gt;AQPixelShaderControlRegAddrs&lt;br&gt;gcregVSThrottleRegAddrs ...&lt;br&gt;&lt;/div&gt;&lt;div&gt;gcregVSInstructionPrefetchRegAddrs ...&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;_clCmdLoadSingleHWState(states, gcregTWTriggerRegAddrs, 0xBADABEEB)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;AQFlushRegAddrs&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//Semaphare STALL&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, AQSemaphoreRegAddrs, semaphoreStall);&lt;br&gt;__clCmdLoadSignleFECommand(states, STALL, semaphoreStall);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//通过semaphore同步&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;MultiGPUSync(cmdBuffer)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//Invalid ICache&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregSHIcacheInvalidateRegAddrs, ...)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-48">
          <mxGeometry y="78" width="530" height="482" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-52" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-51">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-319" y="678" as="sourcePoint" />
            <mxPoint x="-122" y="446" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-57" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-170" y="1310" width="530" height="190" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-58" value="&lt;b&gt;addCmdToQueue(halQueue_PTR queue, cmdBuffer_PTR cmdBuffer)&lt;/b&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-57">
          <mxGeometry y="26" width="530" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-59" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-57">
          <mxGeometry y="52" width="530" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-60" value="&lt;b&gt;updateHalqueueFence&lt;/b&gt;(queue, queue-&amp;gt;processor, cmdBuffer)&lt;br&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; queue-&amp;gt;halFence-&amp;gt;expectedVal = cmdBuffer-&amp;gt;helper.index; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;// gCmdIdx++ 初始化&lt;/span&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; addr = getFenceGPULogical(queue-&amp;gt;halFence, processor)&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; fence-&amp;gt;node-&amp;gt;gpuLogical + fence-&amp;gt;offsetInBytes&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;clfSendFenceWithEngine&lt;/b&gt;(cmdBuffer, fence-&amp;gt;expectedVal, addr, 0)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//把cmdBuffer 挂载到queue-&amp;gt;commandQueue上面&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;os_queue_append&lt;/b&gt;(queue-&amp;gt;commandQueue, cmdBuffer)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-57">
          <mxGeometry y="60" width="530" height="130" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-61" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.997;exitY=0.824;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-57">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-425" y="1130" as="sourcePoint" />
            <mxPoint x="-263" y="1353" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-62" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="470" y="1330" width="690" height="450" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-63" value="&lt;b&gt;clfSendFenceWithEngine(cmdBuffer_PTR cmdBuffer, uint64_t data, devAddress_t dstAddress, int32_t engine)&lt;br&gt;&lt;/b&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;// data 就是expectedVal,&amp;nbsp; &lt;br&gt;// dstAddress是GPU看到的halFence_PTR地址&lt;br&gt;// engine ??&lt;/span&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-62">
          <mxGeometry y="26" width="690" height="74" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-64" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-62">
          <mxGeometry y="100" width="690" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-65" value="dataL = data &amp;amp; 0xFFFFFFFF&lt;div&gt;dataH = (data&amp;gt;&amp;gt;32) &amp;amp;0xFFFFFFFF&lt;br&gt;&lt;br&gt;dstAddressHigh = devADDRESS_HIGH(dstAddress)&lt;br&gt;dstAddressLow&amp;nbsp; = devADDRESS_LOW(dstAddress)&lt;br&gt;&lt;br&gt;if(engine == gcvENGINE_BLT) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (hasBlt) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //Semaphore 配置???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleHWState(states, gcregBltGeneralControlRegAddrs, LOCK)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;__clCmdLoadSingleHWState(states, AQSemaphoreRegAddrs, semaphoreStall)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleFECommand(states, STALL, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleHWState(states, gcregBltGeneralControlRegAddrs, UNLOCK)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else { ...&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//添加Fence cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregFenceAddressRegAddrs, dstAddressLow)&lt;br&gt;__clCmdLoadSingleHWState(states, gcregFenceDataHighRegAddrs, dataH)&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregFenceDataRegAddrs, dataL)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-62">
          <mxGeometry y="108" width="690" height="342" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-66" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=-0.003;entryY=0.038;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-58" target="QSAenKkpdjQW8zQk9t1L-62">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="730" y="860" as="sourcePoint" />
            <mxPoint x="889" y="1295" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-67" value="queue_sched.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="1290" y="-400" width="340" height="236" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-68" value="&lt;b&gt;simple_round_robin(void* p)&lt;/b&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-67">
          <mxGeometry y="26" width="340" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-69" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-67">
          <mxGeometry y="52" width="340" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-70" value="&lt;div&gt;while(1)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; cmd = &lt;b&gt;os_queue_head&lt;/b&gt;(q-&amp;gt;commandQueue)&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;commitCmdBuffer&lt;/b&gt;(cmd, &amp;amp;commitInfo)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;releaseCommandBuffer&lt;/b&gt;(cmd)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;os_queue_pop_head&lt;/b&gt;(q-&amp;gt;commandQueue)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-67">
          <mxGeometry y="60" width="340" height="150" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-76" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-67">
          <mxGeometry y="210" width="340" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-71" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="1160" y="-74" width="600" height="756" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-72" value="commitCmdBuffer(cmdBuffer_PTR cmd, commitInfo_PTR info)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-71">
          <mxGeometry y="26" width="600" height="24" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-73" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-71">
          <mxGeometry y="50" width="600" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-74" value="gcsHAL_INTERFACE iface = { &lt;font color=&quot;#ff3333&quot;&gt;gcvHAL_COMMIT&lt;/font&gt;}&amp;nbsp;&lt;div&gt;gcsHAL_SUBCOMMIT subCommit[gcvCORE_COUNT+1] = {{0}}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;offset = processor-&amp;gt;commandBufferOffset&amp;nbsp; //?? 更新逻辑,&amp;nbsp; &amp;nbsp;256&lt;/span&gt;&lt;/div&gt;&lt;div&gt;cmdTailSize = CMD_reservedTailSize&amp;nbsp; &amp;nbsp;// 8 * CORE_MAX_COUNT&lt;/div&gt;&lt;div&gt;cmdCount = getCommandCount(cmd); // host 已经准备的cmd, 162&lt;/div&gt;&lt;div&gt;cmdSize&amp;nbsp; &amp;nbsp;= cmdCount*4 + CMD_reservedTailSize + CMD_reservedHeadSize, 808&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;&lt;br&gt;//之后还会align cmdSize到64再重新计算cmdTailSize&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//计算当前cmdCount, 再设置 cmdIdx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;commitIdx = processor-&amp;gt;commitCmdIdx&lt;/div&gt;&lt;div&gt;cmdIdx = commitIdx + totalCount&lt;br&gt;processor-&amp;gt;commitCmdIdx = cmdIdx&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//准备拷贝cmdBuffer_PTR中的cmd到 subCommit中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;readIdx = processor-&amp;gt;devReadCmdIdx&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;subCommit[i].commandBuffer.startOffset = offset;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;logical = getCPUAddr(process-&amp;gt;commandBufferPool, processor) + offset; // cpu_logical&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;dst = logical + CMD_reservedHeadSize;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//拷贝host准备的cmd数据到 commandBufferPool当中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;memcpy(dst, cmd-&amp;gt;cmdBase, getCommandCount(cmd)*4)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;offset+= cmdSize&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iface.u.Commit.shared = !bDuplicate;&lt;/div&gt;&lt;div&gt;subCommit[i].context = processor-&amp;gt;context[i]&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.delta =0,&amp;nbsp; .queue = 0,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.address = getDeviceAddr(processor-&amp;gt;commandBufferPool. processor)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.logical&amp;nbsp; &amp;nbsp; = getCPUAddr(processor-&amp;gt;commandBufferPool, processor)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.size&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; = cmdSize&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.reservedHead = CMD_reservedHeadSize &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//32&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.reservedTail = cmdTailSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//152&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.videoMemNode = processor-&amp;gt;commandBufferPool-&amp;gt;handle&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.entryPipe = gcvPIPE_3D , exitPipe = gcvPIPE_3D&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.exitIndex = &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;bDuplicate &lt;/span&gt;? 0 : 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.priority = 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;channelId &lt;/span&gt;= 1,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.next = subCommit + i + 1&lt;/div&gt;&lt;div&gt;iface.u.Commit.subCommit = subCommit[0]&lt;/div&gt;&lt;div&gt;iface.u.Commit.broCoreMask = &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;broCoreMask&lt;/span&gt;&lt;br&gt;iface.cmmitMutex = false&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;KmdIoCtl(processor-&amp;gt;kmdHandle, IOCTL_GCHAL_INTERFACE, &amp;amp;iface, sizeof(iface) .....)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//iface.u.Commit.contextSwitched) 可以查询是否有context切换&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-71">
          <mxGeometry y="58" width="600" height="672" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-77" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-71">
          <mxGeometry y="730" width="600" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-75" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.49;exitY=1.023;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-76" target="QSAenKkpdjQW8zQk9t1L-71">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="1550" y="-467" as="sourcePoint" />
            <mxPoint x="1670" y="-684" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-78" value="gc_hal_kernel.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="1930" y="-90" width="750" height="120" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-79" value="gckKERNEL_Dispatch(gckKERNEL kernel, gckDEVICE Device, gcsHAL_INTERFACE *Interface)&amp;nbsp;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-78">
          <mxGeometry y="26" width="750" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-80" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-78">
          <mxGeometry y="52" width="750" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-81" value="switch(Interface-&amp;gt;command)&lt;br&gt;case gcvHAL_COMMIT:&lt;br&gt;&amp;nbsp; &amp;nbsp; _Commit(Device, Kernel-&amp;gt;hardware-&amp;gt;type, Interface-&amp;gt;engine, processID, Interface-&amp;gt;u.Commit.broCoreMask, &amp;amp;Interface-&amp;gt;u.Commit)&amp;nbsp;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-78">
          <mxGeometry y="60" width="750" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-82" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-77" target="QSAenKkpdjQW8zQk9t1L-78">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="1930" y="40" as="sourcePoint" />
            <mxPoint x="1933" y="129" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-84" value="gc_hal_kernel.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="1930" y="160" width="920" height="120" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-85" value="&lt;b&gt;_Commit(gckDEVICE Device, gceHARDWARE_TYPE HwType, gceENGINE Engine, gctUINT32 ProcessId, gctUNIT32 BroCoreMask, gcsHAL_COMMIT *Commit)&lt;/b&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-84">
          <mxGeometry y="26" width="920" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-86" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-84">
          <mxGeometry y="52" width="920" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-87" value="switch(Interface-&amp;gt;command)&lt;br&gt;case gcvHAL_COMMIT:&lt;br&gt;&amp;nbsp; &amp;nbsp; _Commit(Device, Kernel-&amp;gt;hardware-&amp;gt;type, Interface-&amp;gt;engine, processID, Interface-&amp;gt;u.Commit.broCoreMask, &amp;amp;Interface-&amp;gt;u.Commit)&amp;nbsp;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="QSAenKkpdjQW8zQk9t1L-84">
          <mxGeometry y="60" width="920" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
