<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0" version="25.0.3">
  <diagram name="Page-1" id="9GhINJhexpfvpIPdTT9F">
    <mxGraphModel dx="2754" dy="2823" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="qWvV4iFXAZPfeYybYjg1-6" value="gc_hal_kernel_hardware_waitlink_fe.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_Link(hardware, Logical, FetchAddress, FetchSize, Bytes, Low, High)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; address = FetchAddress&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //CommandBuffer 算是offset的Device地址&lt;br&gt;&amp;nbsp; &amp;nbsp; High = FetchAddress&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bytes = align(FetchAddress + FetchSize, 64) - FetchAddress //CommandBuffer 有效的大小&lt;br&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Hardware-&amp;gt;graphicsLargeVA) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 1, 0)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// OPCODE先清零(配置好 cmd再设置 OPCODE&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 2，address)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 低32位&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckOS_WriteMemory(os, logical + 3 , FetchAddress &amp;gt;&amp;gt; 32);&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 高32位&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;link = ... //设置link为 LINK64 并且PREFETCH大小为bytes&amp;gt;&amp;gt;3 &lt;font color=&quot;#ff3333&quot;&gt;// 配置link的 opcode&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckOS_WriteMemory(os, logical, link)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;font color=&quot;#ff3333&quot;&gt;// 设置CMD的 OPCODE, Prefetch&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;Low = link&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="6580" y="-1720" width="720" height="290" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-8" value="gc_hal_kernel_hardware_waitlink_fe.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_WaitLink(hardware, Logical, Address, Offset, Bytes, WaitOffset, WaitSize)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; hw-&amp;gt;lastWaitLink = Address //保存 WAIT/LINK的地址&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; opLogical = Logical;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//设置WAIT命令&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical++ = ... // WAIT64 与 hw-&amp;gt;waitCount;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; opLogical++&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#ff3333&quot;&gt;//设置LINK命令, 当前LINK到 WAIT命令, 形成LOOP&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical++ = ...// LINK64 与 PREFETCH&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *opLogical = Address;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WaitOffset = 0;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WaitSize = waitSize;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Bytes = bytes;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="6590" y="-1320" width="720" height="260" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-10" value="gc_hal_kernel_hardware.c&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckHARDWARE_Fence(hardware, Engine, Logical, FenceAddress, FenceData, Bytes)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; if (Engine == gcvENGINE_RENDER)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; _FenceRender(hw, Logical, FenceAddress, FenceData, Bytes)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; dataLow = FenceData&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; dataHigh = FenceData &amp;gt;&amp;gt; 32&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (logical) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE....)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E75 gcregFenceAddressHiRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, FenceAddress &amp;gt;&amp;gt; 32); //设置Fence State 地址高32bit&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...) //设置 E1A gcregFenceAddressRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, fenceAddress)&amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 fence低32位&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E26 gcregFenceDataHighRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, dataHigh)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, LOAD_STATE...)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//设置 E1B gcregFenceDataRegAddrs&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gcmkWRITE_MEMORY(logical, dataLow)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Bytes = gcdRENDER_FENCE_LENGTH+8&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="6590" y="-960" width="720" height="360" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-12" value="&lt;div&gt;gc_hal_kernel_kernel.cpp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckKERNEL_Notify(kernel, Notification)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; switch(Notification) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; case gcvNOTIFY_INTERRUPT:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckHARDWARE_Notify(kernel-&amp;gt;hardware)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; gckEVENT_Notify(Hardware-&amp;gt;kernel-&amp;gt;eventObj, 0, &amp;amp;fault);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; for (;;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckOS_AtomGet(Event-&amp;gt;os, Event-&amp;gt;pending, &amp;amp;pending);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if( pending &amp;amp; (1&amp;lt;&amp;lt;29) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//event29 是 invalidation pipe的特殊EVENT&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if( pending &amp;amp; 0x80000000) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;//AXI bus error&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;if (pending &amp;amp; 0x40000000) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// MMU exception&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;...&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gckFENCE_Signal(os, Event-&amp;gt;kernel-&amp;gt;command-&amp;gt;fence)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="7630" y="-1500" width="450" height="400" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="qWvV4iFXAZPfeYybYjg1-13" target="qWvV4iFXAZPfeYybYjg1-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qWvV4iFXAZPfeYybYjg1-13" value="&lt;div&gt;gc_hal_kernel_emulator.cpp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;InterruptThread(void *)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;while(wrapper-&amp;gt;interruptSuspended)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;gckHARDWARE_Interrupt(kernel-&amp;gt;hardware)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;gckKERNEL_Notify(kernel, gcvNOTIFY_INTERRUPT)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;arcSize=2;align=left;horizontal=1;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="7630" y="-1720" width="450" height="160" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-1" value="&lt;span style=&quot;text-align: left;&quot;&gt;drv_api.cpp&lt;/span&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-1000" y="-1435" width="630" height="606" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-2" value="&lt;div&gt;&lt;b&gt;drvLaunchKernelEx_common(config, f, kernelParams, extra, ptsz):&lt;br&gt;&lt;/b&gt;&amp;nbsp; &amp;nbsp; kernelParams: 就是user传入的args,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; extra: ???&amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; ptsz: 是否是perThread Stream&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-1" vertex="1">
          <mxGeometry y="26" width="630" height="74" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-3" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//获取CUcontext&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;div&gt;ctx = getCurrentContext()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;//获取gridDimX/Y/Z, blockDimX/Y/Z, sharedMemBytes等配置信息&lt;br&gt;&lt;/span&gt;gridDimX = config-&amp;gt;gridDimX&lt;br&gt;...&lt;br&gt;sharedMemBytes = config-&amp;gt;sharedMemBytes&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//获取CUStream&lt;/span&gt;&lt;/div&gt;&lt;div&gt;hStream = getCurrentStream(ctx, stream, perThread)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//根据 f-&amp;gt;kernelInfo-&amp;gt;argCount 创建kernelArgData_t&lt;/span&gt;&lt;/div&gt;&lt;div&gt;kernelArgData_t* argData = malloc(sizeof(kernelArgData_t)*argCount)&lt;/div&gt;&lt;div&gt;for (;;) {&lt;br&gt;&amp;nbsp; &amp;nbsp; kernelArgData_t data = argData + i;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; kernelArg_t arg = &lt;font color=&quot;#ff3333&quot;&gt;f-&amp;gt;kernelInfo&lt;/font&gt;-&amp;gt;args + i;&lt;br&gt;&amp;nbsp; &amp;nbsp; data-&amp;gt;arg = arg&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ... //&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//准备 halQueue_t 与 halCommand_t&lt;/span&gt;&lt;br&gt;halQueue = getCurrentStream(ctx, hStream, false)-&amp;gt;halQueue &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//此时 hStream是有效指针, 基本是直接返回&lt;/span&gt;&lt;br&gt;command = {&lt;font color=&quot;#ff3333&quot;&gt;COMMAND_KERNEL&lt;/font&gt;} &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//设置command 为KERNEL(type 有COPY, WAIT, FENCE 等)&lt;/span&gt;&lt;br&gt;&lt;font color=&quot;#ff3333&quot;&gt;executeKrnelInfo_t&lt;/font&gt; *info = command.kernelInfo&lt;br&gt;info-&amp;gt;local[0] = blockDimX...; info-&amp;gt;gridDim[0] = gridDimX ...; info-&amp;gt;global[0]= gridDimX*info-&amp;gt;local[0] ...&lt;br&gt;info-&amp;gt;args = argData;&lt;/div&gt;&lt;div&gt;info-&amp;gt;kInfo= f-&amp;gt;kernelInfo;&lt;br&gt;info-&amp;gt;inst = f-&amp;gt;kernel&lt;/div&gt;&lt;div&gt;prepareExecInfo(info)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//调用&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#ff3333&quot;&gt;&lt;b&gt;launchCommand(halQueue, &amp;amp;command)&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-1" vertex="1">
          <mxGeometry y="100" width="630" height="480" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-32" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-1" vertex="1">
          <mxGeometry y="580" width="630" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-5" value="Color Chart" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="690" y="-1685" width="160" height="138" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-7" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="26" width="160" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-6" value="Context" style="text;strokeColor=#6c8ebf;fillColor=#dae8fc;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="34" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-8" value="Command" style="text;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="60" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-16" value="Comment" style="text;strokeColor=#82b366;fillColor=#FFFFCC;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="86" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-17" value="???" style="text;strokeColor=#82b366;fillColor=#FFE599;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-5" vertex="1">
          <mxGeometry y="112" width="160" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-9" value="&lt;span style=&quot;text-align: left;&quot;&gt;stream.cpp&lt;/span&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-1135" width="490" height="220" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-10" value="&lt;div&gt;&lt;b&gt;getCurrentStream(CUcontext ctx, CUStream stream, bool perThread):&lt;br&gt;&lt;/b&gt;&amp;nbsp; &amp;nbsp; stream 用户传入的stream&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-9" vertex="1">
          <mxGeometry y="26" width="490" height="44" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-11" value="&lt;div&gt;istream = (size_t)stream;&lt;/div&gt;switch(istream)&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;case 0: return getDefaultStream(ctx, perThread)&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;--&amp;gt; 如果perThread --&amp;gt; getPerThreadStream(ctx)&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;否则 --&amp;gt;getLegacyStream(ctx) --&amp;gt; ctx-&amp;gt;legacy &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;(如何创建???)&lt;/span&gt;&lt;br&gt;case 1: return getLegacyStream(ctx)&lt;br&gt;case 2: return getPerThreadStream(ct)&lt;br&gt;default:&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;... &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//和delayDestroy 相关 ???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-9" vertex="1">
          <mxGeometry y="70" width="490" height="150" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-19" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;drv_api.cpp&lt;/span&gt;&lt;/div&gt;" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-1425" width="490" height="140" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-20" value="&lt;div&gt;&lt;b&gt;getCurrentContext():&lt;/b&gt;&amp;nbsp;获取当前的context&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-19" vertex="1">
          <mxGeometry y="26" width="490" height="24" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-21" value="&lt;div&gt;tssData_PTR tss = getTssData(); &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取线程本地数据&lt;/span&gt;&lt;br&gt;&lt;br&gt;ctx = utilStackTop(tss-&amp;gt;ctxStack); &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取最近创建的CUcontext&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return gpgpuPLS.drvDevices[tss-&amp;gt;runtimeDeviceId]-&amp;gt;primaryCtx &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//如何创建???&lt;/span&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-19" vertex="1">
          <mxGeometry y="50" width="490" height="90" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-25" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-880" y="-755" width="390" height="176" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-26" value="&lt;b&gt;launchCommand(halQueue_PTR queue, halCommand_t * cmd)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="26" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-27" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="52" width="390" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-28" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//根据type调用相应的函数&lt;br&gt;&lt;/span&gt;switch(cmd-&amp;gt;type)&lt;br&gt;case &lt;font color=&quot;#ff3333&quot;&gt;COMMAND_KERNEL&lt;/font&gt;: &lt;b&gt;executeKernel(queue, cmd)&lt;/b&gt;&lt;br&gt;...&lt;br&gt;case&amp;nbsp;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="60" width="390" height="90" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-34" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-25" vertex="1">
          <mxGeometry y="150" width="390" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-33" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.501;exitY=1.038;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-32" target="QSAenKkpdjQW8zQk9t1L-25" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-980" y="-785" as="sourcePoint" />
            <mxPoint x="-900" y="-785" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-35" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-962" y="-475" width="550" height="320" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-36" value="&lt;b&gt;executeKernel(halQueue_PTR queue, halCommand* halCmd)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-35" vertex="1">
          <mxGeometry y="26" width="550" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-37" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-35" vertex="1">
          <mxGeometry y="52" width="550" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-38" value="executeKernelInfo_t * execInfo = &amp;amp;halCmd-&amp;gt;kernelInfo&lt;br&gt;&lt;br&gt;execInfo-&amp;gt;halQueue = queue&lt;br&gt;cmdBuffer_PTR &lt;font color=&quot;#ff3333&quot;&gt;cmdBuffer &lt;/font&gt;= &lt;b&gt;createCommandBuffer&lt;/b&gt;(processor, 1024, 1024)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;clfBeginVIRUniform(&lt;font color=&quot;#ff3333&quot;&gt;cmdBuffer&lt;/font&gt;, execInfo-&amp;gt;inst, null)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; //添加硬件配置cmd, 并且写入 semaphoreStall 与 Stall 命令&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;__clCmdLoadSingalHWState(states, AQSemaphoreRegAddrs, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;__clCmdLoadingFECommand(states, STALL, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;allocInternalMemory(execInfo)&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;clfEndVIRUniform(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;clfInvokeVIRKernel&lt;/b&gt;(cmdBuffer, execInfo-&amp;gt;inst, execInfo-&amp;gt;workDim, ...., &amp;amp;invokeInfo)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//把cmdBuffer挂载到queue的commandQueue上&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;addCmdToQueue&lt;/b&gt;(queue, cmdBuffer)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-35" vertex="1">
          <mxGeometry y="60" width="550" height="260" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-39" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.51;entryY=0.005;entryDx=0;entryDy=0;exitX=0.508;exitY=1.035;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-34" target="QSAenKkpdjQW8zQk9t1L-35" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-674" y="-818" as="sourcePoint" />
            <mxPoint x="-675" y="-745" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-41" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-715" width="460" height="300" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-42" value="&lt;b&gt;createCommandBuffer(processor, size)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-41" vertex="1">
          <mxGeometry y="26" width="460" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-43" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-41" vertex="1">
          <mxGeometry y="52" width="460" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-44" value="cmd = malloc(sizeof(cmdBuffer_t))&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//通过cmd-Buffer - cmdBase 可以计算cmd的个数&lt;br&gt;&lt;/span&gt;cmd-&amp;gt;cmdBase = malloc(size)&lt;br&gt;cmd-&amp;gt;cmdBuffer = cmd-&amp;gt;cmdBase&lt;br&gt;cmd-&amp;gt;processor = processor&lt;br&gt;cmd-&amp;gt;helper.index = gCmdIdx++;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//向cmdBuffer中添加init cmds&lt;/span&gt;&lt;/div&gt;&lt;div&gt;clfInitCommandQueue(cmd)&lt;br&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//通过&amp;nbsp;__clCmdLoadSingleHWState 往cmdBuffer添加LoadState 配置&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;28A AQSystemRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E13 AQModeRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;5580 gcregShaderMiscConfigRegAddrs&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E44 gcregClusterControlRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;E80 gcregMultiChipControlRegAddrs&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-41" vertex="1">
          <mxGeometry y="60" width="460" height="240" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-45" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=-0.005;entryY=0.053;entryDx=0;entryDy=0;exitX=1.006;exitY=0.166;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-41" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-672" y="-548" as="sourcePoint" />
            <mxPoint x="-669" y="-474" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-46" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.003;entryY=0.111;entryDx=0;entryDy=0;exitX=1.002;exitY=0.298;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-3" target="QSAenKkpdjQW8zQk9t1L-19" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-360" y="-1049" as="sourcePoint" />
            <mxPoint x="-243" y="-1265" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-47" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.001;entryY=0.083;entryDx=0;entryDy=0;exitX=0.997;exitY=0.594;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-3" target="QSAenKkpdjQW8zQk9t1L-9" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-359" y="-1182" as="sourcePoint" />
            <mxPoint x="-199" y="-1359" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-48" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="-385" width="530" height="560" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-49" value="&lt;b&gt;clfInvokeVIRKernel(cmdBuffer_PTR cmdBuffer, KernelInst_PTR kernelInst,...)&lt;br&gt;通过将要运行的kernel, 配置cmd buffer&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-48" vertex="1">
          <mxGeometry y="26" width="530" height="44" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-50" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-48" vertex="1">
          <mxGeometry y="70" width="530" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-51" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;compilerCmd = *states; //states 就是cmdBuffer-&amp;gt;cmdBuffer&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;compilerCmdCount = hwStates-&amp;gt;stateBufferSize/sizeof(uint32_t)&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //22&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;memcpy(*states, hwStates-&amp;gt;pStateBuffer, hwStates-&amp;gt;stateBufferSize)&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;*states += compilerCmdCount;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//配置指令地址 0x040A&lt;/span&gt;&lt;div&gt;physical = getDeviceAddr(kernelInst-&amp;gt;instMem, kernelInst-&amp;gt;processor)&lt;br&gt;__clCmdLoadSingleHWState(states, gcregPSInstructionRegAddrs, physical)&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//NN相关&lt;/span&gt;&lt;/div&gt;&lt;div&gt;clfTCBasicConfig(cmdBuffer, kernelInst)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//Load State 配置&lt;/div&gt;&lt;div&gt;AQPixelShaderInputControlRegAddrs&amp;nbsp;&lt;br&gt;AQPixelShaderTemporaryRegisterControlRegAddrs&lt;/div&gt;&lt;div&gt;AQPixelShaderControlRegAddrs&lt;br&gt;gcregVSThrottleRegAddrs ...&lt;br&gt;&lt;/div&gt;&lt;div&gt;gcregVSInstructionPrefetchRegAddrs ...&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;_clCmdLoadSingleHWState(states, gcregTWTriggerRegAddrs, 0xBADABEEB)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;AQFlushRegAddrs&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//Semaphare STALL&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, AQSemaphoreRegAddrs, semaphoreStall);&lt;br&gt;__clCmdLoadSignleFECommand(states, STALL, semaphoreStall);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//通过semaphore同步&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;MultiGPUSync(cmdBuffer)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//Invalid ICache&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregSHIcacheInvalidateRegAddrs, ...)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-48" vertex="1">
          <mxGeometry y="78" width="530" height="482" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-52" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-51" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-399" y="-357" as="sourcePoint" />
            <mxPoint x="-202" y="-589" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-57" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-240" y="276" width="530" height="190" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-58" value="&lt;b&gt;addCmdToQueue(halQueue_PTR queue, cmdBuffer_PTR cmdBuffer)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-57" vertex="1">
          <mxGeometry y="26" width="530" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-59" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-57" vertex="1">
          <mxGeometry y="52" width="530" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-60" value="&lt;b&gt;updateHalqueueFence&lt;/b&gt;(queue, queue-&amp;gt;processor, cmdBuffer)&lt;br&gt;&amp;nbsp; &amp;nbsp; --&amp;gt; queue-&amp;gt;halFence-&amp;gt;expectedVal = cmdBuffer-&amp;gt;helper.index; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;// gCmdIdx++ 初始化&lt;/span&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; addr = getFenceGPULogical(queue-&amp;gt;halFence, processor)&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; --&amp;gt; fence-&amp;gt;node-&amp;gt;gpuLogical + fence-&amp;gt;offsetInBytes&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;clfSendFenceWithEngine&lt;/b&gt;(cmdBuffer, fence-&amp;gt;expectedVal, addr, 0)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//把cmdBuffer 挂载到queue-&amp;gt;commandQueue上面&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;os_queue_append&lt;/b&gt;(queue-&amp;gt;commandQueue, cmdBuffer)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-57" vertex="1">
          <mxGeometry y="60" width="530" height="130" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-61" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.997;exitY=0.824;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-38" target="QSAenKkpdjQW8zQk9t1L-57" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="-505" y="95" as="sourcePoint" />
            <mxPoint x="-343" y="318" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-62" value="chip.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="400" y="295" width="690" height="450" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-63" value="&lt;b&gt;clfSendFenceWithEngine(cmdBuffer_PTR cmdBuffer, uint64_t data, devAddress_t dstAddress, int32_t engine)&lt;br&gt;&lt;/b&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;// data 就是expectedVal,&amp;nbsp; &lt;br&gt;// dstAddress是GPU看到的halFence_PTR地址&lt;br&gt;// engine ??&lt;/span&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-62" vertex="1">
          <mxGeometry y="26" width="690" height="74" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-64" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-62" vertex="1">
          <mxGeometry y="100" width="690" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-65" value="dataL = data &amp;amp; 0xFFFFFFFF&lt;div&gt;dataH = (data&amp;gt;&amp;gt;32) &amp;amp;0xFFFFFFFF&lt;br&gt;&lt;br&gt;dstAddressHigh = devADDRESS_HIGH(dstAddress)&lt;br&gt;dstAddressLow&amp;nbsp; = devADDRESS_LOW(dstAddress)&lt;br&gt;&lt;br&gt;if(engine == gcvENGINE_BLT) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; ...&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (hasBlt) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //Semaphore 配置???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleHWState(states, gcregBltGeneralControlRegAddrs, LOCK)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;__clCmdLoadSingleHWState(states, AQSemaphoreRegAddrs, semaphoreStall)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleFECommand(states, STALL, semaphoreStall)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; __clCmdLoadSingleHWState(states, gcregBltGeneralControlRegAddrs, UNLOCK)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else { ...&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//添加Fence cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregFenceAddressRegAddrs, dstAddressLow)&lt;br&gt;__clCmdLoadSingleHWState(states, gcregFenceDataHighRegAddrs, dataH)&lt;/div&gt;&lt;div&gt;__clCmdLoadSingleHWState(states, gcregFenceDataRegAddrs, dataL)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-62" vertex="1">
          <mxGeometry y="108" width="690" height="342" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-66" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=-0.003;entryY=0.038;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-58" target="QSAenKkpdjQW8zQk9t1L-62" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="650" y="-175" as="sourcePoint" />
            <mxPoint x="809" y="260" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-67" value="queue_sched.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1670" y="-1980" width="340" height="236" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-68" value="&lt;b&gt;simple_round_robin(void* p)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="26" width="340" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-69" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="52" width="340" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-70" value="&lt;div&gt;while(1)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; cmd = &lt;b&gt;os_queue_head&lt;/b&gt;(q-&amp;gt;commandQueue)&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;commitCmdBuffer&lt;/b&gt;(cmd, &amp;amp;commitInfo)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;releaseCommandBuffer&lt;/b&gt;(cmd)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;os_queue_pop_head&lt;/b&gt;(q-&amp;gt;commandQueue)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="60" width="340" height="150" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-76" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-67" vertex="1">
          <mxGeometry y="210" width="340" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-71" value="hal.cpp" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1540" y="-1654" width="600" height="756" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-72" value="commitCmdBuffer(cmdBuffer_PTR cmd, commitInfo_PTR info)" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="26" width="600" height="24" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-73" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="50" width="600" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-74" value="gcsHAL_INTERFACE iface = { &lt;font color=&quot;#ff3333&quot;&gt;gcvHAL_COMMIT&lt;/font&gt;}&amp;nbsp;&lt;div&gt;gcsHAL_SUBCOMMIT subCommit[gcvCORE_COUNT+1] = {{0}}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;offset = processor-&amp;gt;commandBufferOffset&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//?? 更新逻辑,&amp;nbsp; &amp;nbsp;256&lt;/span&gt;&lt;/div&gt;&lt;div&gt;cmdTailSize = CMD_reservedTailSize&amp;nbsp; &amp;nbsp;// 8 * CORE_MAX_COUNT&lt;/div&gt;&lt;div&gt;cmdCount = getCommandCount(cmd); // host 已经准备的cmd, 162&lt;/div&gt;&lt;div&gt;cmdSize&amp;nbsp; &amp;nbsp;= cmdCount*4 + CMD_reservedTailSize + CMD_reservedHeadSize, 808&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;&lt;br&gt;//之后还会align cmdSize到64再重新计算cmdTailSize&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//计算当前cmdCount, 再设置 cmdIdx&lt;/span&gt;&lt;/div&gt;&lt;div&gt;commitIdx = processor-&amp;gt;commitCmdIdx&lt;/div&gt;&lt;div&gt;cmdIdx = commitIdx + totalCount&lt;br&gt;processor-&amp;gt;commitCmdIdx = cmdIdx&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//准备拷贝cmdBuffer_PTR中的cmd到 subCommit中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;readIdx = processor-&amp;gt;devReadCmdIdx&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;subCommit[i].commandBuffer.startOffset = offset;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;logical = getCPUAddr(process-&amp;gt;commandBufferPool, processor) + offset; // cpu_logical&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;dst = logical + CMD_reservedHeadSize;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//拷贝host准备的cmd数据到 commandBufferPool当中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;memcpy(dst, cmd-&amp;gt;cmdBase, getCommandCount(cmd)*4)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;offset+= cmdSize&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;iface.u.Commit.shared = !bDuplicate;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;subCommit[i].context = processor-&amp;gt;context[i]&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//如何创建的???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.delta =0,&amp;nbsp; .queue = 0,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.address = getDeviceAddr(processor-&amp;gt;commandBufferPool. processor)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.logical&amp;nbsp; &amp;nbsp; = getCPUAddr(processor-&amp;gt;commandBufferPool, processor)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.size&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; = cmdSize&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.reservedHead = CMD_reservedHeadSize &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//32&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.reservedTail = cmdTailSize&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//152&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.videoMemNode = processor-&amp;gt;commandBufferPool-&amp;gt;handle&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.entryPipe = gcvPIPE_3D , exitPipe = gcvPIPE_3D&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.exitIndex = &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;bDuplicate &lt;/span&gt;? 0 : 1;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.priority = 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.commandBuffer.&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;channelId &lt;/span&gt;= 1,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;.next = subCommit + i + 1&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;iface.u.Commit.subCommit = subCommit[0]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;iface.u.Commit.broCoreMask = &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;broCoreMask&lt;/span&gt;&lt;br&gt;iface.cmmitMutex = false&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;KmdIoCtl(processor-&amp;gt;kmdHandle, IOCTL_GCHAL_INTERFACE, &amp;amp;iface, sizeof(iface) .....)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//iface.u.Commit.contextSwitched) 可以查询是否有context切换&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="58" width="600" height="672" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-77" value="&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-71" vertex="1">
          <mxGeometry y="730" width="600" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-75" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.49;exitY=1.023;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-76" target="QSAenKkpdjQW8zQk9t1L-71" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="1930" y="-2047" as="sourcePoint" />
            <mxPoint x="2050" y="-2264" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-78" value="gc_hal_kernel.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2400" y="-935" width="750" height="120" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-79" value="gckKERNEL_Dispatch(gckKERNEL kernel, gckDEVICE Device, gcsHAL_INTERFACE *Interface)&amp;nbsp;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-78" vertex="1">
          <mxGeometry y="26" width="750" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-80" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-78" vertex="1">
          <mxGeometry y="52" width="750" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-81" value="switch(Interface-&amp;gt;command)&lt;br&gt;case gcvHAL_COMMIT:&lt;br&gt;&amp;nbsp; &amp;nbsp; _Commit(Device, Kernel-&amp;gt;hardware-&amp;gt;type, Interface-&amp;gt;engine, processID, Interface-&amp;gt;u.Commit.broCoreMask, &amp;amp;Interface-&amp;gt;u.Commit)&amp;nbsp;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-78" vertex="1">
          <mxGeometry y="60" width="750" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-82" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-77" target="QSAenKkpdjQW8zQk9t1L-78" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2390" y="-505" as="sourcePoint" />
            <mxPoint x="2393" y="-416" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-84" value="gc_hal_kernel.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2400" y="-535" width="920" height="350" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-85" value="&lt;b&gt;_Commit(gckDEVICE Device, gceHARDWARE_TYPE HwType, gceENGINE Engine, gctUINT32 ProcessId, gctUNIT32 BroCoreMask, gcsHAL_COMMIT *Commit)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="QSAenKkpdjQW8zQk9t1L-84" vertex="1">
          <mxGeometry y="26" width="920" height="26" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-86" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="QSAenKkpdjQW8zQk9t1L-84" vertex="1">
          <mxGeometry y="52" width="920" height="8" as="geometry" />
        </mxCell>
        <mxCell id="QSAenKkpdjQW8zQk9t1L-87" value="&lt;div&gt;gckCOMMAND command;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gcsHAL_SUBCOMMIT *subCommit = &amp;amp;Commit-&amp;gt;subCommit;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;if (HwType == gcvHARDWARE_3D ...) {&lt;div&gt;&amp;nbsp; &amp;nbsp; kernel = Device-&amp;gt;coreInfoArray[subCommit-&amp;gt;coreId].kernel;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (Engine == gcvENGINE_BLT) { ... }&amp;nbsp;&lt;/div&gt;&lt;div&gt;else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;command = kernel-&amp;gt;command;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventObj&amp;nbsp; &amp;nbsp;= kernel-&amp;gt;eventObj;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckCOMMAND_Commit&lt;/b&gt;(command, subCommit, ProcessId, Commit-&amp;gt;shared, &amp;amp;Commit-&amp;gt;commitStamp, &amp;amp;Commit-&amp;gt;contextSwitched)&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckEVENT_Commit&lt;/b&gt;(eventObj, subCommit-&amp;gt;queue, false, command-&amp;gt;feType != gcvHW_FE_END, Commit-&amp;gt;shared)&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="QSAenKkpdjQW8zQk9t1L-84" vertex="1">
          <mxGeometry y="60" width="920" height="290" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-1" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3560" y="-1194" width="920" height="638" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-2" value="&lt;b&gt;gckCOMMAND_Commit(gckCOMMAND Command, gcsHAL_SUBCOMMIT *SubCommit, ProcessId, Shared, CommitStamp, *contextSwitched)&lt;/b&gt;&lt;div&gt;&lt;b&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;CommitStamp //在提交命令后, 得到Command的commitStamp&lt;/span&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="U14mofKTcunZ6X7Fo2zi-1" vertex="1">
          <mxGeometry y="26" width="920" height="44" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-3" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="U14mofKTcunZ6X7Fo2zi-1" vertex="1">
          <mxGeometry y="70" width="920" height="8" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-4" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;gcsSTATE_DELTA_PTR delta = SubCommit-&amp;gt;delta&lt;br&gt;gckCONTEXT context = NULL;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gcsHAL_COMMAND_LOCATION *cmdLoc = &amp;amp;SubCommit-&amp;gt;commandBuffer;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;gckMMU mmu=NULL&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;if (SubCommit-&amp;gt;context)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;color: rgb(255, 51, 51);&quot;&gt;//通过kernel-&amp;gt;db-&amp;gt;pointerDatabase-&amp;gt;table[(UINT32_T)SubCommit-&amp;gt;context -1] 获取&amp;nbsp; ???如何创建的???&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;&amp;nbsp; &amp;nbsp; context = gckKERNEL_QueryPointerFromName(Command-&amp;gt;kernel, SubCommit-&amp;gt;context)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;do {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; gckKERNEL_GetCurrentMMU(Command-&amp;gt;kernel, true, 0, &amp;amp;mmu) &lt;font color=&quot;#ff3333&quot;&gt;//???如何创建的???&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;kernel-&amp;gt;processPageTable &amp;amp;&amp;amp; &lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;Command-&amp;gt;currContext!=context&lt;/span&gt;)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;gckKERNEL_SwitchMMU(Command-&amp;gt;kernel, Shared, mmu)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#ff3333&quot;&gt;&amp;nbsp; &amp;nbsp; //获取power/Command 锁, 递增Command-&amp;gt;atomCommit&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; gckCOMMAND_EnterCommit&lt;/b&gt;(Command, false)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; _HandlePatchList(Command, cmdLoc, &amp;amp;pathListVar)&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;feType == gcvHW_FE_WAIT_LINK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;b&gt;_CommitWaitLinkOnce&lt;/b&gt;(Command, context, cmdLoc, delta, ProcessId, Shared, contextSwitched, NULL, false, ...)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {....}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckCOMMAND_ExitCommit&lt;/b&gt;(Command, false)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; next = cmdLoc-&amp;gt;next&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; userPtr = next&lt;/div&gt;&lt;div&gt;} while(userPtr)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*CommitStamp = Command-&amp;gt;commitStamp&lt;br&gt;Command-&amp;gt;commitStamp++&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="U14mofKTcunZ6X7Fo2zi-1" vertex="1">
          <mxGeometry y="78" width="920" height="560" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-5" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.412;entryY=0.014;entryDx=0;entryDy=0;exitX=0.503;exitY=1.084;exitDx=0;exitDy=0;entryPerimeter=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-81" target="QSAenKkpdjQW8zQk9t1L-84" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2230" y="134" as="sourcePoint" />
            <mxPoint x="2380" y="-905" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-6" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="4750" y="-1800" width="910" height="1930" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-7" value="_CommitWaitLinkOnce(gckCOMMAND Command, gckCONTEXT Context, gcsHAL_COMMAND_LOCATION *CommandBuffer, StateDelta, ProcessID, Shared, ....)" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="26" width="910" height="26" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-8" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="52" width="910" height="8" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-9" value="hardware = Command-&amp;gt;kernel-&amp;gt;hardware&lt;br&gt;&lt;br&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//查询 LINK 的大小(应为有LINK64或者LINK 两种link cmd)&lt;br&gt;&lt;/span&gt;&lt;b&gt;gckWLFE_Link&lt;/b&gt;(hardware, NULL, 0, 0, &amp;amp;linkBytes, NULL, NULL)&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//logical + CMD_ReservedHeadSize 就是KMD之前的用户cmds&lt;/span&gt;&lt;/div&gt;&lt;div&gt;commandBufferLogical = CommandBuffer-&amp;gt;logical + CommandBuffer-&amp;gt;startOffset;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;commandBufferAddress = CommandBuffer-&amp;gt;address + CommandBuffer-&amp;gt;startOffset;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//size就是KMD之前的用户cmds + reserved head + tail 对齐64的大小&lt;/span&gt;&lt;/div&gt;&lt;div&gt;commandBufferSize = CommandBuffer-&amp;gt;size;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;gckCOMMAND_CheckFlushMMU(Command, hardware) //会根据情况刷MMU&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;if (Command-&amp;gt;kernel-&amp;gt;asyncCommand &amp;amp;&amp;amp; MaxAsyncTimeStamp!=0) {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; _WaitForAsyncCommandStamp(Command, MaxAsyncTimeStamp)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取当前kernel command的offset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;offset = Command-&amp;gt;offset&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //144&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取当前kernel command queue 剩下的bytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;bytes = Command-&amp;gt;pageSize - offset&amp;nbsp; // 4096 - offset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//查询 WAIT/LINK cmd 序列的大小，这里的offset是计算size时计算对齐地址用的&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;gckWLFE_WaitLink&lt;/b&gt;(hw, NULL, INVALID_ADDR, offset, &amp;amp;waitLinkBytes, NULL, NULL) //waitLinkBytes = 32&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//检查kernel command queue 是否有足够的空间&lt;/span&gt;&lt;/div&gt;&lt;div&gt;if (bytes &amp;lt; waitLinkBytes) { ... }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Command Queue 的起始地址&lt;/span&gt;&lt;/div&gt;&lt;div&gt;waitLinkLogical = Command-&amp;gt;logical + offset&lt;/div&gt;&lt;div&gt;waitLinkAddress = Command-&amp;gt;address + offset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (Context == NULL) {&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;} else if (Command-&amp;gt;currContext != Context) {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;&amp;nbsp; &amp;nbsp; contextBuffer = Context-&amp;gt;buffer;&lt;br&gt;&amp;nbsp; &amp;nbsp; //合并delta 数据到context buffer&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(204, 255, 255);&quot;&gt;&amp;nbsp; &amp;nbsp; gckCONTEXT_Update(Context, ProcessID, StateDelta)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;&amp;nbsp; &amp;nbsp; //得到 context buffer 的 entry offset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; offset = (Command-&amp;gt;pipeSelect == gcvPIP_3D) ? &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; Context-&amp;gt;entryOffset3D + Context-&amp;gt;pipSelectBytes&amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//+8 就是跳过 pipe switching sequence&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; : Context-&amp;gt;entryOffset3D&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; //不跳过 pipe switching sequence&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//得到context buffer 的起始地址与大小&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; entryLogical = contextBuffer-&amp;gt;logical + offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; entryAddress = contextBuffer-&amp;gt;address + offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; entryBytes = Context-&amp;gt;bufferSize - offset&amp;nbsp; //&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 255, 204);&quot;&gt;//检查是否需要添加切换pipe的cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (CommandBuffer-&amp;gt;entryPipe == gcvPIPE_3D) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//跳过切换pipe的预留cmd长度&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; offset = CommandBuffer-&amp;gt;reservedHead&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//通过 gckHARDWARE_PipeSelect(...) 添加切换pipe的cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//通过 contextBuffer link3D的位置 LINK 到 commandBuffer + offset(就是command buffer 的起始)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckWLFE_Link&lt;/b&gt;(hw,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;contextBuffer-&amp;gt;link3D, &lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferAddress + offset,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferSize - offset,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;amp;linkBytes, &amp;amp;commandLinkLow, &amp;amp;commandLinkHigh)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckVIDMEM_NODE_CleanCache&lt;/b&gt;(..., contextBuffer-&amp;gt;videoMem, (entryAddress - contextBuffer-&amp;gt;address), entryLogical, &lt;b&gt;entryBytes&lt;/b&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//切换context&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;currContext = Context;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *contextSwitched = true;&lt;/div&gt;&lt;div&gt;} else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; ... //相同context&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;newQueue) {...}&lt;br&gt;&amp;nbsp; &amp;nbsp; else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//设置之前Context Command Qeue的退出地址, 也就是新的Command的起始地址 一个 WAIT/LINK 序列&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exitAddress = waitLinkAddress;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exitBytes = waitLinkBytes;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//在Command buffer的头上加入Wait/Link 序列, 暂时LOOP&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckWLFE_WaitLink&lt;/b&gt;(hw, waitLinkLogical, waitLinkAddress, offset, &amp;amp;waitLinkBytes, &amp;amp;waitOffset, &amp;amp;waitSize)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Command-&amp;gt;newQueue) {...}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(.., Command-&amp;gt;videoMem, Command-&amp;gt;offset, waitLinkLogical, &lt;b&gt;exitBytes&lt;/b&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//得到commandBuffer末尾的位置&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; commandBufferTail = commandBufferLogical + commandBufferSize - CommandBuffer-&amp;gt;reservedTail&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;//生成写 commit stamp的 Fence cmd&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 229, 153);&quot;&gt;&lt;b&gt;gckHARDWARE_Fence&lt;/b&gt;(hw, gcvENGIN_RENDER, commandBufferTail, Command-&amp;gt;fence-&amp;gt;address, Command-&amp;gt;commitStamp, &amp;amp;fencebytes)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; commandBufferTail += fencebytes;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (Shared == false) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;gckWLFE_Link&lt;/b&gt;(hw,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;commandBufferTail,&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//添加LINK 到command buffer 末尾&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;exitAddress,&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//LINK的地址就是 command buffer 的头, 之前在command buffer 头已经加上了WAIT/LINK序列&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;exitBytes, &amp;amp;linkBytes, &amp;amp;exitLinkLow, &amp;amp;exitLinkHight)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else { ...}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckVIDMEM_HANDLE_Lookup(); gckVIDMEM_NODE_CleanCache(); //查找commandBufferVideoMem, 并清除cache&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Link到entryAddress, 此处的LINK会替换之前的WAIT/LINK 序列, 让整个Command 执行起来&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckWLFE_Link&lt;/b&gt;(hw, Command-&amp;gt;waitPos.logical,&amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//???&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entryAddress,&amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Link到 context-&amp;gt;buffer(如果有context)&lt;/span&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; entryBytes,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;Command-&amp;gt;WaitPos.size,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;entryLinkLow, &amp;amp;entryLinkHigh)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(..., Command-&amp;gt;waitPos.videoMem, Command-&amp;gt;waitPos.offset, Command-&amp;gt;waitPos.logical...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//更新当前 pipe&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;pipeSelect = CommandBuffer-&amp;gt;exitPipe&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;offset += waitLinkBytes;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;newQueue = false;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;//此处更新Command的等待地址 ???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPost.videoMem = Command-&amp;gt;videoMem;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.offset = Command-&amp;gt;offset - waitLinkBytes + waitOffset;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.address = waitLinkAddress + waitOffset;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;&amp;nbsp; &amp;nbsp; Command-&amp;gt;waitPos.size = waitSize&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckHARDWARE_UpdateQueueTail&lt;/b&gt;(hw, Command-&amp;gt;logical, Command-&amp;gt;offset)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" parent="U14mofKTcunZ6X7Fo2zi-6" vertex="1">
          <mxGeometry y="60" width="910" height="1870" as="geometry" />
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-10" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.999;exitY=0.292;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="QSAenKkpdjQW8zQk9t1L-87" target="U14mofKTcunZ6X7Fo2zi-1" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2797" y="-355" as="sourcePoint" />
            <mxPoint x="2799" y="-285" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="U14mofKTcunZ6X7Fo2zi-11" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0.003;entryY=0.186;entryDx=0;entryDy=0;exitX=1.001;exitY=0.147;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" source="U14mofKTcunZ6X7Fo2zi-4" target="U14mofKTcunZ6X7Fo2zi-7" edge="1">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="2881" y="58" as="sourcePoint" />
            <mxPoint x="2880" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-2" value="gc_hal_kernel_event.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="3560" y="-80" width="610" height="190" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-3" value="&lt;b&gt;gckEVENT_Commit(gckEVENT Event, gcsQUEUE_PTR Queue, bool Forced, bool Submit, bool Shared)&amp;nbsp;&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-2">
          <mxGeometry y="26" width="610" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-4" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-2">
          <mxGeometry y="52" width="610" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-5" value="if (Submit) {&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.wait = true&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.shared = Shared&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.fromPower = false&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; eventAttr.broadcase = true&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckEVENT_Submit(Event, &amp;amp;eventAttr)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-2">
          <mxGeometry y="60" width="610" height="130" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-7" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitX=0.996;exitY=0.842;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="QSAenKkpdjQW8zQk9t1L-87" target="UbzL_sldVN1qwGkXepIT-2">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="3339" y="-145" as="sourcePoint" />
            <mxPoint x="3570" y="-610" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-8" value="gc_hal_kernel_event.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="4760" y="400" width="660" height="810" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-9" value="&lt;b style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;gckEVENT_Submit(gckEVENT Event, gckEVENT_PTR EventAttr)&lt;/b&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-8">
          <mxGeometry y="26" width="660" height="24" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-11" value="command = Event-&amp;gt;command&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;queue = Event-&amp;gt;queueHead&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//获取当前 commit stamp &lt;/span&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;(已经被加1???)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;commitStamp = command-&amp;gt;commitStamp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (commitStamp)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&amp;nbsp; &amp;nbsp; commitStamp -= 1&amp;nbsp; //已经被加1???&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckEVENT_GetEvent(Event, wait, &amp;amp;id, queue-&amp;gt;source)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//event ID queue 指向 event list&lt;/span&gt;&lt;/div&gt;&lt;div&gt;Event-&amp;gt;queue[id].head = queue-&amp;gt;head&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//更新commitStamp&lt;/span&gt;&lt;/div&gt;&lt;div&gt;Event-&amp;gt;queue[id].commitStamp = commitStamp&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;//把当前queue 从Event-&amp;gt;queueHead中移除&lt;br&gt;...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (command-&amp;gt;feType == gcvHW_FE_WAIT_LINK || command-&amp;gt;feType == gcvHW_FE_END) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; _QueryFlush(..., &amp;amp;flush) &lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//获取需要Flush的内容&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckWLFE_Event(hw, NULL, id, Event-&amp;gt;queue[id].source, &amp;amp;bytes) //bytes : 32&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckHARDWARE_Flush(hw, flush, NULL, &amp;amp;flushBytes)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bytes += flushBytes&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;executeBytes = bytes&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//Command Qeuue 里面预留空间&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(255, 153, 153);&quot;&gt;gckCOMMAND_Reserve(command, bytes, &amp;amp;buffer, &amp;amp;bytes) //3920&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (command-&amp;gt;feType == gcvHW_FE_WAIT_LINK || command-&amp;gt;feType == gcvHW_FE_END) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; //添加flush cmd 到command queue&lt;br&gt;&amp;nbsp; &amp;nbsp; gckHARDWARE_Flush(hw, flush, buffer, &amp;amp;flushBytes)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; buffer = buffer + flushBytes;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;gckWLFE_Event&lt;/b&gt;(hw, buffer, id, Event-&amp;gt;queues[id].source, &amp;amp;bytes)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if(command-&amp;gt;feType == gcvHW_FE_WAIT_LINK) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gckCOMMAND_Execute(command, executeBytes)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckCOMMAND_ExitCommit(command, fromPower)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-8">
          <mxGeometry y="50" width="660" height="752" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-10" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-8">
          <mxGeometry y="802" width="660" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-12" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="UbzL_sldVN1qwGkXepIT-5" target="UbzL_sldVN1qwGkXepIT-8">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="4300" y="1039" as="sourcePoint" />
            <mxPoint x="4602" y="300" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-13" value="gc_hal_kernel_hardware_waitlink_fe.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="5600" y="590" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-14" value="gckWLFE_Event(hw, Logical, uint8 Event, FromWhere, *Bytes)" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-13">
          <mxGeometry y="26" width="400" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-15" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-13">
          <mxGeometry y="52" width="400" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-16" value="&lt;div&gt;if(blt) {&lt;/div&gt;&amp;nbsp; &amp;nbsp; *logical++ = LOAD_STATE gcregBltGeneralControlRegAddrs&lt;div&gt;&amp;nbsp; &amp;nbsp; *logical++ = LOCK&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (multiCluster) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; *logical++ = LOAD_STATE gcregBltClusterControlRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; *logical++ = hw-&amp;gt;options.userClusterMask&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*logical++ = LOAD_STATE AQEventRegAddrs&lt;/div&gt;&lt;div&gt;*logical++ = Event (EVENT_ID)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if(blt) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; *logical++ = LOAD_STATE gcregBltGeneralControlRegAddrs&lt;br&gt;&amp;nbsp; &amp;nbsp; *logical++ = UNLOCK&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-13">
          <mxGeometry y="60" width="400" height="260" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-17" value="gc_hal_kernel_command.c" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="5600" y="990" width="500" height="740" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-18" value="&lt;b&gt;gckCOMMAND_Execute(gckCOMMAND Command, uint32 RequestedBytes)&lt;/b&gt;" style="text;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;fontColor=#333333;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-17">
          <mxGeometry y="26" width="500" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-19" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-17">
          <mxGeometry y="52" width="500" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-20" value="&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//计算 WAIT/LINK的offset&lt;/span&gt;&lt;/div&gt;waitLinkOffset = Command-&amp;gt;offset + RequestedBytes&lt;div&gt;&lt;span style=&quot;background-color: rgb(230, 230, 230);&quot;&gt;//计算Command queue 剩余字节&lt;/span&gt;&lt;/div&gt;&lt;div&gt;waitLinkBytes = Command-&amp;gt;pageSize - waitLinkOffset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//计算 WAIT/LINK 序列的位置&lt;/span&gt;&lt;/div&gt;&lt;div&gt;waitLinkLogical = Command-&amp;gt;logical + waitLinkOffset;&lt;/div&gt;&lt;div&gt;waitLinkAddress = Command-&amp;gt;address + waitLinkOffset&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//添加 WAIT/LINK 到command queue&lt;/span&gt;&lt;/div&gt;&lt;div&gt;gckWLFE_WaitLink(hw, waitLinkLogical,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkAddress&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkOffset,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitLinkBytes,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;waitOffset, waitBytes)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if (Command-&amp;gt;newQueue) { ...}&lt;/div&gt;&lt;div&gt;else {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; execLogical = Command-&amp;gt;logical + Command-&amp;gt;offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; execAddress = Command-&amp;gt;address + Command-&amp;gt;offset&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; execBytes = RequestedBytes + waitLinkBytes&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; gckVIDMEM_NODE_CleanCache(...)&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;gckWLFE_Link(hw, Command-&amp;gt;waitPos.logical,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; execAddress, execBytes,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;Command-&amp;gt;waitPos,size,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;amp;linkLow, &amp;amp;linkHight)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckVIDMEM_NODE_CleanCache(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//更新到最后一个WAIT&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.videoMem = Command-&amp;gt;videoMem&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.offset = waitLinkOffset + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.logical = waitLinkLogical + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.address = waitLinkAddress + waitOffset&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;waitPos.size = waitBytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;//更新command queue&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;offset += RequestedBytes + waitLinkBytes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: rgb(151, 208, 119);&quot;&gt;Command-&amp;gt;newQueue =false&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gckHARDWARE_UpdateQueueTail(...)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-17">
          <mxGeometry y="60" width="500" height="680" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-21" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=0.992;exitY=0.23;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitPerimeter=0;" edge="1" parent="1" source="UbzL_sldVN1qwGkXepIT-11" target="UbzL_sldVN1qwGkXepIT-13">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="4240" y="465" as="sourcePoint" />
            <mxPoint x="4770" y="421" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-22" value="dispatch" style="html=1;verticalAlign=bottom;endArrow=block;curved=0;rounded=0;exitX=1.001;exitY=0.687;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;exitPerimeter=0;" edge="1" parent="1" source="UbzL_sldVN1qwGkXepIT-11" target="UbzL_sldVN1qwGkXepIT-17">
          <mxGeometry width="80" relative="1" as="geometry">
            <mxPoint x="5425" y="652" as="sourcePoint" />
            <mxPoint x="5610" y="360" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-25" value="createCommandBufferPool(processor_PTR processor)&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;processor-&amp;gt;commandBufferOffset = 256&lt;/div&gt;" style="html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="1110" y="-1750" width="370" height="160" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-26" value="" style="endArrow=classic;html=1;rounded=0;entryX=-0.005;entryY=0.087;entryDx=0;entryDy=0;entryPerimeter=0;exitX=1;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="UbzL_sldVN1qwGkXepIT-25" target="QSAenKkpdjQW8zQk9t1L-74">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1390" y="-1525" as="sourcePoint" />
            <mxPoint x="1440" y="-1575" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-27" value="ENV" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="7650" y="-250" width="270" height="86" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-28" value="VIV_CUDA_DRV_PROFILE" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-27">
          <mxGeometry y="26" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-29" value="" style="line;strokeWidth=1;fillColor=none;align=left;verticalAlign=middle;spacingTop=-1;spacingLeft=3;spacingRight=3;rotatable=0;labelPosition=right;points=[];portConstraint=eastwest;strokeColor=inherit;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-27">
          <mxGeometry y="52" width="270" height="8" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-30" value="+ method(type): type" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;whiteSpace=wrap;html=1;" vertex="1" parent="UbzL_sldVN1qwGkXepIT-27">
          <mxGeometry y="60" width="270" height="26" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-31" value="createCommandBufferPool(processor_PTR processor)&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;processor-&amp;gt;commandBufferOffset = 256&lt;/div&gt;" style="html=1;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="1080" y="-1445" width="370" height="160" as="geometry" />
        </mxCell>
        <mxCell id="UbzL_sldVN1qwGkXepIT-32" value="" style="endArrow=classic;html=1;rounded=0;entryX=0.004;entryY=0.558;entryDx=0;entryDy=0;entryPerimeter=0;exitX=1;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="UbzL_sldVN1qwGkXepIT-31" target="QSAenKkpdjQW8zQk9t1L-74">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1490" y="-1580" as="sourcePoint" />
            <mxPoint x="1547" y="-1528" as="targetPoint" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
